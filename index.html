<meta charset="utf-8"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><style>canvas{image-rendering:pixelated;left:50%;max-height:49%;max-width:49%;position:fixed;top:50%;transform:translate(-50%,-50%)scale(2,2)}</style><body><script>(()=>{"use strict";const t=["backgroundObjects","objects","ground","particles"],e=Object.fromEntries(t.map(((t,e)=>[t,e]))),n=new Map;let o=0;function i(t,i){return o+=1,n.set(o,[e[t],i]),o}function s(t,e){return t+Math.random()*(e-t)}function a(t){return Math.floor(t/24)}function r(t,e,n=!1){const o=document.createElement("canvas");o.width=t,o.height=e;const i=o.getContext("2d");return i.imageSmoothingEnabled=n,[o,i]}let l=0;class f{x;y;constructor(t,e){this.x=t,this.y=e}add(t){return new f(this.x+t.x,this.y+t.y)}mul(t){return new f(this.x*t,this.y*t)}sub(t){return new f(this.x-t.x,this.y-t.y)}round(){return new f(Math.round(this.x),Math.round(this.y))}equal(t){return Boolean(t&&this.x===t.x&&this.y===t.y)}distance(t){return((this.x-t.x)**2+(this.y-t.y)**2)**.5}empty(){return isNaN(this.x)||isNaN(this.y)}within(t,e,n,o){return this.x>=t&&this.x<t+n&&this.y>=e&&this.y<e+o}ensureWithin(t,e,n,o){return new f(Math.min(t+n,Math.max(t,this.x)),Math.min(e+o,Math.max(e,this.y)))}static zero=new f(0,0);static empty=new f(NaN,NaN)}const c=p("base",((t,{x:e,y:n})=>{t.font="60px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ—¼",e+36,n+36+3)}),(()=>({})),(()=>({})),{width:72,height:72}),d={solar:p("solar",((t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸŒž",e+12,n+12+1)}),(()=>({})),(()=>({}))),battery:p("battery",((t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ”‹",e+12,n+12+1)}),(()=>({energyLevel:0})),(()=>({}))),turret:p("turret",((t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ”«",e+12,n+12+1)}),(t=>({mid:new f(24*(t+.5),-12),count:1,range:1,power:1,targets:[]})),(({mid:t,count:e,range:n,power:o})=>{const i=function(t,e,n){const o=[];for(const i of D){const s=i.position.distance(t);if(s>n)continue;const a=o.findIndex((([t])=>s<t));a>=0?(o.splice(a,0,[s,i]),o.length>e&&o.pop()):o.length<e&&o.push([s,i])}return o.map((([,t])=>t))}(t,e,200*n);for(const t of i)t.health-=.02*o;return{targets:i}}))},h={base:c,...d},u={...d};function m(t,{x:e,y:n},{width:o,height:i}){t.strokeStyle="#fff",t.setLineDash([5,5]),t.lineDashOffset=Math.floor(l/60*-20),t.strokeRect(e+.5,n+.5,o-1,i-1),t.setLineDash([])}function p(t,e,n,o,i){return Object.assign((s=>({name:t,...n(s),draw:e,reduceState:o,width:24,height:24,...i})),{draw:e,width:24})}const x={type:"menu"},y=Object.entries(u),w=Object.fromEntries(y.map((([t])=>[t,v(t)]))),g={build:M("build",((t,e)=>{for(const[n,[o,{draw:i,width:s}]]of y.entries()){const a=8+72*n+.5,r=o===O,l="menuBuildObject"===e?.type&&e.name===o;t.fillStyle=r?"#fff":l?"#fff4":"#000",t.fillRect(a,736.5,64,56),t.strokeStyle="#fff",t.strokeRect(a,736.5,64,56),t.fillStyle=r?"#000":"#fff",t.font="12px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText(o,a+32,749.5),i(t,new f(a+(64-s)/2,760.5))}})),info:M("info",(t=>{const e=void 0!==j?T.get(j):void 0;t.font="12px monospace",t.textAlign="left",t.textBaseline="top",t.fillStyle="#fff",t.fillText(e?`Selected object: ${e}`:"select an object to see more details",8,736,484)}))},b=Object.keys(g);function M(t,e){const[,n]=r(1e3,1e3);return n.font="12px monospace",{draw:e,menuItem:{type:"tab",name:t},width:Math.round(n.measureText(t).width)+16-1}}function v(t){return{type:"menuBuildObject",name:t}}let S="build";function k(t){"tab"===t.type&&(S=t.name),"menuBuildObject"===t.type&&(O=t.name)}const T=new Map([[-1,h.base(-1)]]);let j,O,P=-1,B=1;function N(t,e,n){const o=n.within(24*e,-24,24,24);t.strokeStyle=o?"#fff":"#fff8",t.beginPath(),t.arc(24*(e+.5),-12,8,0,2*Math.PI),t.moveTo(24*(e+.3),-12),t.lineTo(24*(e+.7),-12),t.moveTo(24*(e+.5),24*-.3),t.lineTo(24*(e+.5),24*-.7),t.stroke()}function R({x:t,y:e}){const n=a(t),o=n>-1&&n<2?-1:n,i=T.get(o);if(e<=0&&e>=-(i?.height??24))return o}function E(t){void 0===t?(j=void 0,O=void 0):T.has(t)?(j=t,k({type:"tab",name:"info"})):O&&function(t,e){P=Math.min(t,P),B=Math.max(t,B);const n=u[e](t);T.set(t,n)}(t,O)}function I(){return[24*P-500,24*(B+1)-1+500]}const L=new Set;let A=0;const W=Math.PI/6,D=new Set,H=["#444","#666","#888","#aaa","#ccc"];function z(t=Math.floor(s(1,5)),e=s(-W,W),n=s(.5,1.5)/t,o=new f(s(...I())+-1300*Math.tan(e),-1300)){const a=q(t),r={mass:t,angle:e,speed:n,position:o,dPosition:new f(Math.sin(e),Math.cos(e)).mul(n),r:0,dr:Math.sign(Math.random()-.5)*s(.01,.04)/t,health:2**t,maxHealth:2**t,drawableHandle:i("objects",((t,{x1:e,y1:n,width:o,height:i})=>{if(r.position.within(e-a,n-a,o+2*a,i+2*a)){t.fillStyle="#000",t.strokeStyle="#fff",t.beginPath();for(let e=0;e<r.vertexOffsets.length;e+=1){const n=r.vertexOffsets[e]*a,o=r.r+2*Math.PI*(e/r.vertexOffsets.length),i=r.position.x+Math.sin(o)*n,s=r.position.y+Math.cos(o)*n;0===e?t.moveTo(i,s):t.lineTo(i,s)}t.closePath(),t.fill(),t.stroke(),r.health!==r.maxHealth&&(t.lineWidth=2,t.strokeStyle="#0f0",t.beginPath(),t.moveTo(r.position.x-a,r.position.y-a),t.lineTo(r.position.x-a+2*a*r.health/r.maxHealth,r.position.y-a),t.stroke(),t.lineWidth=1)}})),vertexOffsets:C(t)};D.add(r)}function Y(t){if(function(t){D.delete(t),n.delete(t.drawableHandle)}(t),function(t,e,n){const o=e**2*.02;for(let i=0;i<o;i+=1){const o=s(0,2*Math.PI),i=new f(Math.sin(o),Math.cos(o));L.add({position:t.add(i.mul(Math.random()*e)),dPosition:i.mul(1*Math.random()),life:60,color:n[Math.floor(Math.random()*n.length)]})}}(t.position,q(t.mass),H),1===t.mass)return;const e=t.angle;z(t.mass-1,e-Math.PI/12,t.speed*t.mass/(t.mass-1),t.position),z(t.mass-1,e+Math.PI/12,t.speed*t.mass/(t.mass-1),t.position)}function $(t){t.position.y<0||Y(t)}function q(t){return 24*t/2}function C(t){const e=2*Math.round(t)+3,n=[];for(let t=0;t<e;t+=1)n.push(s(.5,1));return n}const[X,F]=r(500,800);X.style.background="#000";let G,J,K,Q=new f(12,-160),U=1,V=f.empty,Z=f.empty,_=f.empty,tt=f.empty,et=!1;function nt({clientX:t,clientY:e}={clientX:NaN,clientY:NaN}){const n=X.getBoundingClientRect();V=new f(500/n.width*(t-n.left),800/n.height*(e-n.top)),Z=V.sub(new f(250,400)).mul(1/U).add(Q),G=function(t){if(!(t.y<704))return function(t){let e=0;for(const n of b){if(t.within(e,704,g[n].width,24))return g[n].menuItem;e+=g[n].width}}(t)??function(t,e){if("build"===S)for(const[t,[n]]of y.entries())if(e.within(8+72*t+.5,736.5,64,56))return w[n]}(0,t)??x}(V)}function ot(t){Q=t.sub(V.sub(new f(250,400)).mul(1/U));const[e,n]=I();Q=Q.ensureWithin(e+251/U,401/U-1200,n-e-502/U,2400-802/U),Q=new f(Math.round(Q.x*U)/U,Math.round(Q.y*U)/U)}function it(){_=f.empty,tt=f.empty,J=void 0,K=void 0,et=!1}function st(){F.resetTransform()}document.title="space-td";let at=0;document.body.style.background="#49f",document.body.append(X),document.addEventListener("mousemove",(t=>{nt(t),!et&&_.distance(V)>5&&(et=!0),et&&ot(tt)})),X.addEventListener("contextmenu",(t=>{t.preventDefault()})),X.addEventListener("wheel",(t=>{nt(t),G||function({deltaY:t}){U=Math.max(.5,Math.min(1.5,U-.08333333333333333*Math.sign(t))),ot(Z)}(t)})),X.addEventListener("mousedown",(t=>{t.preventDefault(),nt(t),G?K=G:(_=V,tt=Z,J=R(Z))})),document.addEventListener("mouseup",(t=>{nt(t),G&&G===K?(E(void 0),k(G)):et||J!==R(Z)||E(J),it()})),document.addEventListener("visibilitychange",(()=>{V=f.empty,Z=f.empty,G=void 0,it()})),i("objects",((t,{position:e,x1:n,x2:o})=>{const i=a(n),s=a(o);for(let n=i;n<=s;n+=-1===n?3:1){const o=T.get(n);if(!o){O&&N(t,n,e);continue}const i=new f(24*n,-o.height);o.draw(t,i);const s=e.within(i.x,i.y,o.width,o.height);(n===j||s)&&m(t,i,o)}})),i("backgroundObjects",(t=>{t.strokeStyle="#f00";for(const e of T.values())if("turret"===e.name){t.lineWidth=e.power/2,t.beginPath();for(const n of e.targets)t.moveTo(e.mid.x,e.mid.y),t.lineTo(n.position.x,n.position.y);t.stroke()}t.lineWidth=1})),i("ground",((t,{x1:e,x2:n})=>{const o=a(e),i=a(n);t.fillStyle="sienna";for(let e=o;e<=i;e+=-1===e?2:1)t.fillRect(24*e,0,24,24)})),i("particles",(t=>{for(const e of L){const n=Math.floor(e.life/60*16);t.fillStyle=`${e.color}${n.toString(16)}`,t.fillRect(e.position.x-1.5,e.position.y-1.5,3,3)}})),function e(o){requestAnimationFrame(e),o>=at+15.666666666666668&&(at=o,l+=1,function(){L.size>A&&(A=L.size);for(const t of L)t.life-=1,0===t.life&&L.delete(t),t.position=t.position.add(t.dPosition)}(),function(){Math.random()>.05||D.size>=80||z();for(const t of D)t.health<=0?Y(t):(t.position=t.position.add(t.dPosition),t.r+=t.dr,$(t))}(),function(){for(const t of T.values())Object.assign(t,t.reduceState(t,{}))}(),st(),F.clearRect(0,0,500,800),F.translate(250,400),F.scale(U,U),F.translate(-Q.x,-Q.y),function(e,o){const i=t.map((()=>[]));for(const[t,e]of n.values())i[t].push(e);for(const t of i)for(const n of t)n(e,o)}(F,{position:Z,x1:Q.x-251/U,y1:Q.y-401/U,x2:Q.x+251/U,y2:Q.y+305/U,width:502/U,height:706/U}),st(),function(t,e){t.fillStyle="#000",t.fillRect(0,704,500,96),t.strokeStyle="#fff",t.strokeRect(.5,704.5,499,95),function(t,e){t.font="12px monospace",t.textAlign="left",t.textBaseline="middle";let n=0;for(const o of b){const i=o===S,s="tab"===e?.type&&e.name===o;t.fillStyle=i?"#fff":s?"#fff4":"#000",t.fillRect(n+.5,704.5,g[o].width,24),t.fillStyle=i?"#000":"#fff",t.fillText(o,n+8,717.5),t.strokeStyle="#fff",t.strokeRect(n+.5,704.5,g[o].width,24),n+=g[o].width}}(t,e),g[S].draw(t,e)}(F,G))}(0);})()</script>
