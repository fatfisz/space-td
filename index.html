<meta charset="utf-8"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><style>canvas{image-rendering:pixelated;left:50%;max-height:49%;max-width:49%;position:fixed;top:50%;transform:translate(-50%,-50%)scale(2,2)}</style><body><script>(()=>{"use strict";const t=["backgroundObjects","objects","ground"],e=Object.fromEntries(t.map(((t,e)=>[t,e]))),n=new Map;let o=0;function i(t,i){return o+=1,n.set(o,[e[t],i]),o}function s(t,e){return t+Math.random()*(e-t)}function a(t){return Math.floor(t/24)}function r(t,e,n=!1){const o=document.createElement("canvas");o.width=t,o.height=e;const i=o.getContext("2d");return i.imageSmoothingEnabled=n,[o,i]}let f=0;class l{x;y;constructor(t,e){this.x=t,this.y=e}add(t){return new l(this.x+t.x,this.y+t.y)}mul(t){return new l(this.x*t,this.y*t)}sub(t){return new l(this.x-t.x,this.y-t.y)}round(){return new l(Math.round(this.x),Math.round(this.y))}equal(t){return Boolean(t&&this.x===t.x&&this.y===t.y)}distance(t){return((this.x-t.x)**2+(this.y-t.y)**2)**.5}empty(){return isNaN(this.x)||isNaN(this.y)}within(t,e,n,o){return this.x>=t&&this.x<t+n&&this.y>=e&&this.y<e+o}ensureWithin(t,e,n,o){return new l(Math.min(t+n,Math.max(t,this.x)),Math.min(e+o,Math.max(e,this.y)))}static zero=new l(0,0);static empty=new l(NaN,NaN)}const c=x("base",((t,{x:e,y:n})=>{t.font="60px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ—¼",e+36,n+36+3)}),(()=>({})),(()=>({})),{width:72,height:72}),h={solar:x("solar",((t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸŒž",e+12,n+12+1)}),(()=>({})),(()=>({}))),battery:x("battery",((t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ”‹",e+12,n+12+1)}),(()=>({energyLevel:0})),(()=>({}))),turret:x("turret",((t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ”«",e+12,n+12+1)}),(t=>({mid:new l(24*(t+.5),-12),count:1,range:1,power:1,targets:[]})),(({mid:t,count:e,range:n,power:o})=>{const i=function(t,e,n){const o=[];for(const i of I){const s=i.position.distance(t);if(s>n)continue;const a=o.findIndex((([t])=>s<t));a>=0?(o.splice(a,0,[s,i]),o.length>e&&o.pop()):o.length<e&&o.push([s,i])}return o.map((([,t])=>t))}(t,e,200*n);for(const t of i)t.health-=.02*o;return{targets:i}}))},d={base:c,...h},u={...h};function m(t,{x:e,y:n},{width:o,height:i}){t.strokeStyle="#fff",t.setLineDash([5,5]),t.lineDashOffset=Math.floor(f/60*-20),t.strokeRect(e+.5,n+.5,o-1,i-1),t.setLineDash([])}function x(t,e,n,o,i){return Object.assign((s=>({name:t,...n(s),draw:e,reduceState:o,width:24,height:24,...i})),{draw:e,width:24})}const y={type:"menu"},p=Object.entries(u),w=Object.fromEntries(p.map((([t])=>[t,v(t)]))),g={build:M("build",((t,e)=>{for(const[n,[o,{draw:i,width:s}]]of p.entries()){const a=8+72*n+.5,r=o===O,f="menuBuildObject"===e?.type&&e.name===o;t.fillStyle=r?"#fff":f?"#fff4":"#000",t.fillRect(a,736.5,64,56),t.strokeStyle="#fff",t.strokeRect(a,736.5,64,56),t.fillStyle=r?"#000":"#fff",t.font="12px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText(o,a+32,749.5),i(t,new l(a+(64-s)/2,760.5))}})),info:M("info",(t=>{const e=void 0!==j?T.get(j):void 0;t.font="12px monospace",t.textAlign="left",t.textBaseline="top",t.fillStyle="#fff",t.fillText(e?`Selected object: ${e}`:"select an object to see more details",8,736,484)}))},b=Object.keys(g);function M(t,e){const[,n]=r(1e3,1e3);return n.font="12px monospace",{draw:e,menuItem:{type:"tab",name:t},width:Math.round(n.measureText(t).width)+16-1}}function v(t){return{type:"menuBuildObject",name:t}}let k="build";function S(t){"tab"===t.type&&(k=t.name),"menuBuildObject"===t.type&&(O=t.name)}const T=new Map([[-1,d.base(-1)]]);let j,O,B=-1,N=1;function P(t,e,n){const o=n.within(24*e,-24,24,24);t.strokeStyle=o?"#fff":"#fff8",t.beginPath(),t.arc(24*(e+.5),-12,8,0,2*Math.PI),t.moveTo(24*(e+.3),-12),t.lineTo(24*(e+.7),-12),t.moveTo(24*(e+.5),24*-.3),t.lineTo(24*(e+.5),24*-.7),t.stroke()}function E({x:t,y:e}){const n=a(t),o=n>-1&&n<2?-1:n,i=T.get(o);if(e<=0&&e>=-(i?.height??24))return o}function R(t){void 0===t?(j=void 0,O=void 0):T.has(t)?(j=t,S({type:"tab",name:"info"})):O&&function(t,e){B=Math.min(t,B),N=Math.max(t,N);const n=u[e](t);T.set(t,n)}(t,O)}function L(){return[24*B-500,24*(N+1)-1+500]}const A=Math.PI/6,I=new Set;function W(t=Math.floor(s(1,5)),e=s(-A,A),n=s(.5,1.5)/t,o=new l(s(...L())+-1300*Math.tan(e),-1300)){const a=24*t/2,r={mass:t,angle:e,speed:n,position:o,dPosition:new l(Math.sin(e),Math.cos(e)).mul(n),r:0,dr:Math.sign(Math.random()-.5)*s(.01,.04)/t,health:2**t,maxHealth:2**t,drawableHandle:i("objects",((t,{x1:e,y1:n,width:o,height:i})=>{if(r.position.within(e-a,n-a,o+2*a,i+2*a)){t.fillStyle="#000",t.strokeStyle="#fff",t.beginPath();for(let e=0;e<r.vertexOffsets.length;e+=1){const n=r.vertexOffsets[e]*a,o=r.r+2*Math.PI*(e/r.vertexOffsets.length),i=r.position.x+Math.sin(o)*n,s=r.position.y+Math.cos(o)*n;0===e?t.moveTo(i,s):t.lineTo(i,s)}t.closePath(),t.fill(),t.stroke(),r.health!==r.maxHealth&&(t.lineWidth=2,t.strokeStyle="#0f0",t.beginPath(),t.moveTo(r.position.x-a,r.position.y-a),t.lineTo(r.position.x-a+2*a*r.health/r.maxHealth,r.position.y-a),t.stroke(),t.lineWidth=1)}})),vertexOffsets:q(t)};I.add(r)}function D(t){if(Y(t),1===t.mass)return;const e=t.angle;W(t.mass-1,e-Math.PI/12,t.speed*t.mass/(t.mass-1),t.position),W(t.mass-1,e+Math.PI/12,t.speed*t.mass/(t.mass-1),t.position)}function H(t){t.position.y<0||Y(t)}function Y(t){I.delete(t),n.delete(t.drawableHandle)}function q(t){const e=2*Math.round(t)+3,n=[];for(let t=0;t<e;t+=1)n.push(s(.5,1));return n}const[z,C]=r(500,800);z.style.background="#000";let X,F,$,G=new l(12,-160),J=1,K=l.empty,Q=l.empty,U=l.empty,V=l.empty,Z=!1;function _({clientX:t,clientY:e}={clientX:NaN,clientY:NaN}){const n=z.getBoundingClientRect();K=new l(500/n.width*(t-n.left),800/n.height*(e-n.top)),Q=K.sub(new l(250,400)).mul(1/J).add(G),X=function(t){if(!(t.y<704))return function(t){let e=0;for(const n of b){if(t.within(e,704,g[n].width,24))return g[n].menuItem;e+=g[n].width}}(t)??function(t,e){if("build"===k)for(const[t,[n]]of p.entries())if(e.within(8+72*t+.5,736.5,64,56))return w[n]}(0,t)??y}(K)}function tt(t){G=t.sub(K.sub(new l(250,400)).mul(1/J));const[e,n]=L();G=G.ensureWithin(e+251/J,401/J-1200,n-e-502/J,2400-802/J),G=new l(Math.round(G.x*J)/J,Math.round(G.y*J)/J)}function et(){U=l.empty,V=l.empty,F=void 0,$=void 0,Z=!1}function nt(){C.resetTransform()}document.title="space-td";let ot=0;document.body.style.background="#49f",document.body.append(z),document.addEventListener("mousemove",(t=>{_(t),!Z&&U.distance(K)>5&&(Z=!0),Z&&tt(V)})),z.addEventListener("contextmenu",(t=>{t.preventDefault()})),z.addEventListener("wheel",(t=>{_(t),X||function({deltaY:t}){J=Math.max(.5,Math.min(1.5,J-.08333333333333333*Math.sign(t))),tt(Q)}(t)})),z.addEventListener("mousedown",(t=>{t.preventDefault(),_(t),X?$=X:(U=K,V=Q,F=E(Q))})),document.addEventListener("mouseup",(t=>{_(t),X&&X===$?(R(void 0),S(X)):Z||F!==E(Q)||R(F),et()})),document.addEventListener("visibilitychange",(()=>{K=l.empty,Q=l.empty,X=void 0,et()})),i("objects",((t,{position:e,x1:n,x2:o})=>{const i=a(n),s=a(o);for(let n=i;n<=s;n+=-1===n?3:1){const o=T.get(n);if(!o){O&&P(t,n,e);continue}const i=new l(24*n,-o.height);o.draw(t,i);const s=e.within(i.x,i.y,o.width,o.height);(n===j||s)&&m(t,i,o)}})),i("backgroundObjects",(t=>{t.strokeStyle="#f00";for(const e of T.values())if("turret"===e.name){t.lineWidth=e.power/2,t.beginPath();for(const n of e.targets)t.moveTo(e.mid.x,e.mid.y),t.lineTo(n.position.x,n.position.y);t.stroke()}t.lineWidth=1})),i("ground",((t,{x1:e,x2:n})=>{const o=a(e),i=a(n);t.fillStyle="sienna";for(let e=o;e<=i;e+=-1===e?2:1)t.fillRect(24*e,0,24,24)})),function e(o){requestAnimationFrame(e),o>=ot+15.666666666666668&&(ot=o,f+=1,function(){Math.random()>.05||I.size>=80||W();for(const t of I)t.health<=0?D(t):(t.position=t.position.add(t.dPosition),t.r+=t.dr,H(t))}(),function(){for(const t of T.values())Object.assign(t,t.reduceState(t,{}))}(),nt(),C.clearRect(0,0,500,800),C.translate(250,400),C.scale(J,J),C.translate(-G.x,-G.y),function(e,o){const i=t.map((()=>[]));for(const[t,e]of n.values())i[t].push(e);for(const t of i)for(const n of t)n(e,o)}(C,{position:Q,x1:G.x-251/J,y1:G.y-401/J,x2:G.x+251/J,y2:G.y+305/J,width:502/J,height:706/J}),nt(),function(t,e){t.fillStyle="#000",t.fillRect(0,704,500,96),t.strokeStyle="#fff",t.strokeRect(.5,704.5,499,95),function(t,e){t.font="12px monospace",t.textAlign="left",t.textBaseline="middle";let n=0;for(const o of b){const i=o===k,s="tab"===e?.type&&e.name===o;t.fillStyle=i?"#fff":s?"#fff4":"#000",t.fillRect(n+.5,704.5,g[o].width,24),t.fillStyle=i?"#000":"#fff",t.fillText(o,n+8,717.5),t.strokeStyle="#fff",t.strokeRect(n+.5,704.5,g[o].width,24),n+=g[o].width}}(t,e),g[k].draw(t,e)}(C,X))}(0);})()</script>
