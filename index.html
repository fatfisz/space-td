<meta charset=utf-8><meta name=viewport content=width=device-width,initial-scale=1,user-scalable=no><style>*{box-sizing:border-box}:root{color:#fff;font:1.5vmin monospace}a{color:inherit}button{background:none;border:1px solid #fff;color:#fff;font:inherit}.screen,canvas{image-rendering:pixelated;left:50%;max-height:49%;max-width:49%;position:fixed;top:50%;transform:translate(-50%,-50%)scale(2,2);transition:background 2s,opacity 2s}#main{text-align:center}#info{padding:2vmin}.margin{margin-top:10vmin}.smol{font-size:.5em}</style><body><script>(()=>{"use strict";const t=["backgroundObjects","objects","ground","decorative","particles"],e=Object.fromEntries(t.map(((t,e)=>[t,e]))),n=new Set;function i(t,i){n.add([e[t],i])}function o(t,e){return t+Math.random()*(e-t)}function a(t){return Math.floor(t/24)}function r(t,e){return`${t},${e}`}function s(t){return t.split(",").map((t=>+t))}let l=0;class c{x;y;constructor(t,e){this.x=t,this.y=e}add(t){return new c(this.x+t.x,this.y+t.y)}mul(t){return new c(this.x*t,this.y*t)}sub(t){return new c(this.x-t.x,this.y-t.y)}distance(t){return((this.x-t.x)**2+(this.y-t.y)**2)**.5}within(t,e,n,i){return this.x>=t&&this.x<t+n&&this.y>=e&&this.y<e+i}ensureWithin(t,e,n,i){return new c(Math.min(t+n,Math.max(t,this.x)),Math.min(e+i,Math.max(e,this.y)))}static zero=new c(0,0);static empty=new c(NaN,NaN)}const d=new Set,f=new Set;function u(t,e,n){if(n<=0)return;const i=r(e,n);d.has(i)||t.has(i)||t.add(i)}const h=p({name:"base",maxHealth:20,getState:()=>({}),upgrades:{armor:1},extra:{width:72,height:72},draw:(t,{x:e,y:n})=>{t.font="60px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ—¼",e+36,n+36+3)}}),m={"solar panel":p({name:"solar panel",maxHealth:2,getState:()=>({}),upgrades:{efficiency:1,armor:1},draw:(t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸŒž",e+12,n+12+1)}}),battery:p({name:"battery",maxHealth:4,getState:()=>({energy:0}),upgrades:{storage:1,armor:1},draw:(t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ”‹",e+12,n+12+1)}}),turret:p({name:"turret",maxHealth:8,getState:()=>({targets:[]}),upgrades:{count:1,range:1,power:1,armor:1},draw:(t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ”«",e+12,n+12+1)}}),drill:p({name:"drill",maxHealth:1/0,getState:()=>({ticksLeft:120}),upgrades:{},extra:{addParticlesWhenDestructing:!1},draw:(t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("â›ï¸",e+12,n+12+1)}})},y={base:h,...m};function g(t,{x:e,y:n},{width:i,height:o}){t.strokeStyle="#fff",t.setLineDash([5,5]),t.lineDashOffset=Math.floor(l/60*-20),t.strokeRect(e+.5,n+.5,i-1,o-1),t.setLineDash([])}function p({name:t,maxHealth:e,getState:n,upgrades:i,extra:o,draw:a}){const r={name:t,width:24,height:24,health:e,maxHealth:e,draw:a,...o};return{get:(t,e)=>{const o={mid:new c(24*t+r.width/2,24*(e+1)-r.height/2),armor:1/0,upgrade:function(t){o[t]=Math.min(o[t]+1,3)},...i,...r,...n?.(t,e)};return o},...r}}const x=new Set;let w=0;function v(t,e,n,i=!1){const a=e**2*(i?.08:.04);for(let i=0;i<a;i+=1){const i=o(0,2*Math.PI),a=new c(Math.sin(i),Math.cos(i));x.add({mid:t.add(a.mul(Math.random()*e)),dMid:a.mul(1*Math.random()),life:60,color:n[Math.floor(Math.random()*n.length)]})}}function M(t,e,n){i("decorative",(i=>{i.lineWidth=2,i.strokeStyle=t,i.beginPath();for(const t of e()){const{value:e,mid:o,offsetY:a,width:r}=n(t);e<0||(i.moveTo(o.x-r/2,o.y+a),i.lineTo(o.x-r/2+r*e,o.y+a))}i.stroke(),i.lineWidth=1}))}const b=new Map,S=["#fc0","#fa0","#f80","#f60","#f40","#ff0"],k=new Set,T=new Set,R=new Set,E=new Set,L={energy:1,battery:0,resources:0};let P,H,$=-1,A=1;function B(){if(!H)return[];if("drill"===H)return function(){const t=new Set;for(const e of d){const[n,i]=s(e);u(t,n-1,i),u(t,n+1,i),u(t,n,i-1),u(t,n,i+1)}return[...t].map((t=>new c(...s(t))))}().filter((t=>!b.has(r(t.x,t.y))&&!b.has(r(t.x,t.y-1))));const[t,e]=C(),n=[];for(let i=t;i<=e;i+=1)(i<-1||i>=2)&&!b.has(r(i,-1))&&n.push(new c(i,-1));return"battery"===H?[...n,...(1===d.size?[]:[...d].filter((t=>{const[e,n]=s(t);return!d.has(r(e,n+1))})).map((t=>new c(...s(t))))).filter((t=>!b.has(r(t.x,t.y))))]:n}function z(t,e,n){const i=n.within(24*e.x,24*e.y,24,24);t.strokeStyle=i?"#fff":"#fff8",t.beginPath(),t.arc(24*(e.x+.5),24*(e.y+.5),8,0,2*Math.PI),t.moveTo(24*(e.x+.3),24*(e.y+.5)),t.lineTo(24*(e.x+.7),24*(e.y+.5)),t.moveTo(24*(e.x+.5),24*(e.y+.3)),t.lineTo(24*(e.x+.5),24*(e.y+.7)),t.stroke()}function I({x:t,y:e}){const n=D(a(t),a(e));if(b.get(n)||B().some((t=>r(t.x,t.y)===n)))return n}function N(t){void 0===t?(P=void 0,H=void 0):b.has(t)?("drill"!==b.get(t).name&&(P=t),H=void 0):H&&function(t,e){const[n,i]=s(t);$=Math.min(n,$),A=Math.max(n,A);const o=m[e].get(n,i);b.set(t,o),"solar panel"===o.name?k.add(o):"battery"===o.name?T.add(o):"turret"===o.name?R.add(o):"drill"===o.name&&(E.add(o),function(t){f.add(t)}(t))}(t,H)}function W(t,e){b.delete(t),"base"===e.name&&Rt("end"),(e.addParticlesWhenDestructing??1)&&v(e.mid,e.height/2,S,!0),P===t&&(P=void 0),"solar panel"===e.name?k.delete(e):"battery"===e.name?T.delete(e):"turret"===e.name?R.delete(e):"drill"===e.name&&(E.delete(e),function(t){f.delete(t),d.add(t)}(t),L.resources+=100)}function O(){return L}function Y(){return void 0!==P?b.get(P):void 0}function j(){return H}function C(){return[24*$-500,24*(A+1)-1+500]}function D(t,e){return t>=-1&&t<2&&e>-4&&e<=-1?r(-1,-1):r(t,e)}function V(t){return 1+Math.round(10*Math.log(t))/10}const F=Math.PI/6,X=new Set,q=["#eee","#ccc","#aaa","#888","#666","#444"];function G(t=Math.floor(o(1,5)),e=o(-F,F),n=o(.5,1.5)/t,i=new c(o(...C())+-1300*Math.tan(e),-1300)){const a={mass:t,radius:24*t/2,angle:e,speed:n,mid:i,dMid:new c(Math.sin(e),Math.cos(e)).mul(n),r:0,dr:Math.sign(Math.random()-.5)*o(.01,.04)/t,health:2**t,maxHealth:2**t,vertexOffsets:Q(t),computedVertices:[]};J(a),X.add(a)}function U(t){if(X.delete(t),v(t.mid,t.radius,q),1===t.mass)return;const e=t.angle;G(t.mass-1,e-Math.PI/12,t.speed,t.mid),G(t.mass-1,e+Math.PI/12,t.speed,t.mid)}function J(t){t.computedVertices=t.vertexOffsets.map(((e,n,{length:i})=>{const o=t.r+2*Math.PI*(n/i);return new c(t.mid.x+Math.sin(o)*e*t.radius,t.mid.y+Math.cos(o)*e*t.radius)}))}function K(t){const e=function(t){for(const e of t){const t=D(a(e.x),a(e.y)),n=b.get(t);if(n&&e.y<=0&&e.y>=-n.height)return n}}(t.computedVertices);if(e)return e.health-=function(t){const e=t.health/t.maxHealth;return t.mass**2*e+(t.mass-1)**2*(1-e)}(t)*(1-.25*(e.armor-1)),void U(t);t.computedVertices.some((({y:t})=>t>0))&&U(t)}function Q(t){const e=2*Math.round(t)+3,n=[];for(let t=0;t<e;t+=1)n.push(o(.5,1));return n}function Z(t,e,n){const i=[];for(const o of X){const a=o.mid.distance(t);if(a>n)continue;const r=i.findIndex((([t])=>a<t));r>=0?(i.splice(r,0,[a,o]),i.length>e&&i.pop()):i.length<e&&i.push([a,o])}return i.map((([,t])=>t))}function _(t,e,n=!1){const i=document.createElement("canvas");i.width=t,i.height=e;const o=i.getContext("2d");return o.imageSmoothingEnabled=n,[i,o]}const[tt,et]=_(500,800);tt.style.background="#000";const nt=[],it=new c(0,0).distance(new c(250,800))+100,ot={build:rt(Object.values(m),((t,{left:e,active:n},{name:i,width:o,draw:a})=>{t.font="12px monospace",t.fillStyle=n?"#000":"#fff",t.textAlign="center",t.textBaseline="middle",t.fillText(lt(i),e+50,757),a(t,new c(e+(100-o)/2,768))}),(({name:t})=>{H=t}),(()=>{const t=j();return t&&m[t]})),"upgrade base":st(["armor"]),"upgrade solar panel":st(["efficiency","armor"]),"upgrade battery":st(["storage","armor"]),"upgrade turret":st(["power","range","count","armor"])};function at(){const t=Y()?.name;return t?`upgrade ${t}`:"build"}function rt(t,e,n,i){return{options:t,draw:(n,o)=>{for(const[a,r]of t.entries()){const t=100*a,s=i?.()===r,l=a===o;n.fillStyle=s?"#fff":l?"#fff4":"#222",n.fillRect(t,744,100,56),n.strokeStyle="#fff",n.beginPath(),n.moveTo(t+100-.5,744),n.lineTo(t+100-.5,800),n.stroke(),e(n,{left:t,active:s,hover:l},r)}},optionClick:n}}function st(t){return rt(t,((t,{left:e,active:n},i)=>{t.font="12px monospace",t.fillStyle=n?"#000":"#fff",t.textAlign="center",t.textBaseline="middle",t.fillText(lt(i),e+50,757);const o=Y()[i];t.fillText(3===o?`Maxed (${o})`:`${o} ðŸ – ${o+1}`,e+50,781)}),(t=>{Y().upgrade(t)}))}function lt(t){return t.replace(/(^| )([a-z])/g,((t,e,n)=>`${e}${n.toUpperCase()}`))}const[ct,dt]=_(500,800);let ft,ut,ht=new c(12,-160),mt=1,yt=c.empty,gt=c.empty,pt=c.empty,xt=c.empty,wt=!1,vt=!1;function Mt({clientX:t,clientY:e}={clientX:NaN,clientY:NaN}){const n=ct.getBoundingClientRect();yt=new c(500/n.width*(t-n.left),800/n.height*(e-n.top)),gt=yt.sub(new c(250,400)).mul(1/mt).add(ht),ft=function(t){if(!(t.y<720&&t.y>40)){if(t.within(377,8,115,24))return-1;for(let e=0;e<500/108;e+=1)if(t.within(100*e,744,100,56))return e;return-2}}(yt)}function bt(t){ht=t.sub(yt.sub(new c(250,400)).mul(1/mt));const[e,n]=C();ht=ht.ensureWithin(e+251/mt,401/mt-1200,n-e-502/mt,2400-802/mt),ht=new c(Math.round(ht.x*mt)/mt,Math.round(ht.y*mt)/mt)}function St(){pt=c.empty,xt=c.empty,ut=void 0,wt=!1,vt=!1}function kt(){dt.resetTransform()}let Tt="init";function Rt(t){Tt=t,"init"===Tt&&(window.main.style.background="",window.main.style.pointerEvents=""),"play"===Tt&&(window.game.style.opacity="",window.game.style.pointerEvents="",window.main.style.opacity="0",window.main.style.pointerEvents="none",setTimeout((()=>{window.main.style.background="#fff"}),2e3),ht=new c(12,-160),mt=1,yt=c.empty,gt=c.empty,ft=void 0,pt=c.empty,xt=c.empty,ut=void 0,wt=!1,vt=!1,X.clear(),b.clear(),b.set(r(-1,-1),y.base.get(-1,-1)),k.clear(),T.clear(),R.clear(),E.clear(),d.clear(),d.add(r(0,0)),f.clear(),x.clear()),"end"===Tt&&(window.game.style.opacity="0",window.game.style.pointerEvents="none",window.main.style.opacity="",window.score.innerHTML=b.has(r(-1,-1))?`Score: ${L.resources}`:`Score: ${Math.round(L.resources/2)}<br><div class=smol>(destroyed base: -50%)</div>`,setTimeout((()=>{Rt("init")}),2e3))}document.title="Asteroid Miner";let Et=0;document.body.style.background="#49f",function(){document.body.append(tt);for(let t=0;t<200;t+=1){const t=o(0,2*Math.PI),e=o(0,it**2)**.5,n=Math.round(o(300,600));nt.push({mid:new c(Math.sin(t)*e,Math.cos(t)*e),cycleOffset:Math.floor(o(0,n)),cycleLength:n})}}(),ct.id="game",ct.style.opacity="0",ct.style.pointerEvents="none",document.body.append(ct),document.addEventListener("mousemove",(t=>{Mt(t),!wt&&pt.distance(yt)>5&&(wt=!0),wt&&bt(xt)})),ct.addEventListener("contextmenu",(t=>{t.preventDefault()})),ct.addEventListener("wheel",(t=>{Mt(t),void 0===ft&&function({deltaY:t}){mt=Math.max(.5,Math.min(1.5,mt-.08333333333333333*Math.sign(t))),bt(gt)}(t)})),ct.addEventListener("mousedown",(t=>{t.preventDefault(),Mt(t),void 0!==ft?(vt=!0,function(t){if(-1===t)return void Rt("end");const e=at();"build"===at()&&N(void 0),void 0!==t&&t>=0&&t<ot[e].options.length&&ot[e].optionClick(ot[e].options[t])}(ft)):(pt=yt,xt=gt,ut=I(gt))})),document.addEventListener("mouseup",(t=>{Mt(t),wt||vt||ut!==I(gt)||N(ut),St()})),document.addEventListener("visibilitychange",(()=>{yt=c.empty,gt=c.empty,ft=void 0,St()})),function(){const t=document.createElement("div");t.className="screen",t.id="main",t.innerHTML='<div class=margin>Asteroid Miner</div><div class=margin><button id=start>Start</button> <button id=showinfo>How to play</button></div><div class=margin id=score></div><div class="margin smol">Made by <a href=https://fatfisz.com/>FatFisz</a></div>',document.body.appendChild(t),window.start.onclick=()=>{Rt("play")},window.showinfo.onclick=()=>{t.style.opacity="0",e.style.opacity="",e.style.pointerEvents=""};const e=document.createElement("div");function n(){const{width:n,height:i}=window.game.getBoundingClientRect();t.style.width=n/2+"px",t.style.height=i/2+"px",e.style.width=n/2+"px",e.style.height=i/2+"px"}e.className="screen",e.id="info",e.innerHTML="<p class=margin>Welcome to the future, where asteroid mining is booming âœ¨</p><p>Your job is to mine as much resources as possible without getting obliterated by smaller (yet very destructive) asteroids.</p><p>First dig using a drill, then build and upgrade (access by clicking on a building) your power supply and defences.</p><p>When you feel ready, you can launch the rocket - as long as it's not yet destroyed!</p><button id=back>Got it</button>",e.style.opacity="0",e.style.pointerEvents="none",document.body.appendChild(e),window.back.onclick=()=>{t.style.opacity="",e.style.opacity="0",e.style.pointerEvents="none"},n(),window.onresize=n}(),i("objects",((t,{x1:e,y1:n,width:i,height:o})=>{for(const a of X){if(!a.mid.within(e-a.radius,n-a.radius,i+2*a.radius,o+2*a.radius))continue;t.fillStyle="#666",t.strokeStyle="#aaa",t.beginPath();let r=!0;for(const{x:e,y:n}of a.computedVertices)r?(r=!1,t.moveTo(e,n)):t.lineTo(e,n);t.closePath(),t.fill(),t.stroke()}})),M("#0c0",(()=>X),(({radius:t,mid:e,health:n,maxHealth:i})=>({mid:e,offsetY:-t,width:2*t,value:n/i}))),i("objects",((t,{position:e})=>{for(const n of b.values()){const i=a(n.mid.x-n.width/2),o=a(n.mid.y-n.height/2),s=new c(24*i,24*o);n.draw(t,s);const l=e.within(s.x,s.y,n.width,n.height);(r(i,-1)===P||l)&&g(t,s,n)}})),i("decorative",((t,e)=>{for(const n of B())z(t,n,e.position)})),i("backgroundObjects",(t=>{const e=Math.floor(15*L.energy);t.strokeStyle=`#f00${e.toString(16)}`;for(const e of b.values())if("turret"===e.name){t.lineWidth=e.power/2,t.beginPath();for(const n of e.targets)t.moveTo(e.mid.x,e.mid.y),t.lineTo(n.mid.x,n.mid.y);t.stroke()}t.lineWidth=1})),M("#0c0",(()=>b.values()),(({mid:t,width:e,height:n,health:i,maxHealth:o})=>({mid:t,width:e-2,offsetY:-n/2-4,value:i/o}))),M("#49f",(()=>T),(({mid:t,width:e,height:n,energy:i,storage:o})=>({mid:t,width:e-2,offsetY:-n/2-1,value:i/o}))),M("#f00",(()=>E),(({mid:t,width:e,height:n,ticksLeft:i})=>({mid:t,width:e-2,offsetY:-n/2-1,value:(120-i)/120}))),i("ground",((t,{x1:e,y1:n,x2:i,y2:o})=>{const s=a(e),l=Math.max(a(n),0),c=a(i),u=a(o);t.fillStyle="#643";for(let e=l;e<=u;e+=1)for(let n=s;n<=c;n+=1){const i=r(n,e);d.has(i)||f.has(i)||t.fillRect(24*n,24*e,24,24)}})),i("particles",(t=>{for(const e of x){const n=Math.floor(e.life/60*16);t.fillStyle=`${e.color}${n.toString(16)}`,t.fillRect(e.mid.x-1.5,e.mid.y-1.5,3,3)}})),function e(i){requestAnimationFrame(e),i>=Et+15.666666666666668&&(Et=i,l+=1,"play"!==Tt&&"end"!==Tt||(function(){x.size>w&&(w=x.size);for(const t of x)t.life-=1,0===t.life&&x.delete(t),t.mid=t.mid.add(t.dMid)}(),function(){Math.random()>.05||X.size>=80||G();for(const t of X)t.health<=0?U(t):(t.mid=t.mid.add(t.dMid),t.r+=t.dr,J(t),K(t))}(),function(){for(const[t,e]of b.entries())e.health<=0&&W(t,e);let t=20;for(const{efficiency:e}of k)t+=10*e*1;let e=0;for(const{energy:t}of T)e+=4500*t;let n=0;for(const t of R){const{mid:e,count:i,range:o,power:a}=t;t.targets=Z(e,i,200*o),n+=t.targets.length*V(i)*V(a)*15}n+=5*E.size;const i=Math.min(n,t+e);L.energy=i/n||1;for(const t of R){const{targets:e,power:n}=t;for(const t of e)t.health-=.02*n*L.energy}for(const t of E)t.ticksLeft-=L.energy,t.ticksLeft<=0&&W(r(a(t.mid.x),a(t.mid.y)),t);let o=(t-i)/4500;if(o>0){const t=[...T];for(let e=0;e<t.length;e+=1){const n=t[e],i=Math.min(o/(t.length-e),n.storage-n.energy);n.energy+=i,o-=i}}else if(o<0){const t=[...T].reverse();for(let e=0;e<t.length;e+=1){const n=t[e],i=Math.max(o/(t.length-e),-n.energy);n.energy+=i,o-=i}}let s=0,l=0;for(const{energy:t,storage:e}of T)s+=t,l+=e;L.battery=s/l}()),function(){const t=l*Math.PI*2/18e3;et.clearRect(0,0,500,800),et.fillStyle="#fff";for(const e of nt){const n=new c(e.mid.x*Math.cos(t)-e.mid.y*Math.sin(t)+250,e.mid.y*Math.cos(t)+e.mid.x*Math.sin(t)+800+100);if(!n.within(0,0,500,800))continue;const i=Math.floor((Math.sin((e.cycleOffset+l)/e.cycleLength*Math.PI*2)+1)/2*16);et.fillStyle=`#fff${i.toString(16)}`,et.fillRect(n.x-1.5,n.y-1.5,3,3)}}(),kt(),dt.clearRect(0,0,500,800),dt.translate(250,400),dt.scale(mt,mt),dt.translate(-ht.x,-ht.y),function(e,i){const o=t.map((()=>[]));for(const[t,e]of n)o[t].push(e);for(const t of o)for(const n of t)n(e,i)}(dt,{position:gt,x1:ht.x-251/mt,y1:ht.y-361/mt,x2:ht.x+251/mt,y2:ht.y+321/mt,width:502/mt,height:722/mt}),kt(),function(t,e){const n=O(),i=at();t.fillStyle="#222",t.fillRect(0,0,500,40),t.strokeStyle="#fff",t.beginPath(),t.moveTo(0,39.5),t.lineTo(500,39.5),t.stroke(),t.fillStyle="#0c04",t.fillRect(8,8,115,24),t.fillStyle="#0c0",t.fillRect(8,8,115*n.energy,24),t.strokeRect(8.5,8.5,114,23),t.fillStyle="#49f4",t.fillRect(131,8,115,24),t.fillStyle="#49f",t.fillRect(131,8,115*n.battery,24),t.strokeRect(131.5,8.5,114,23),t.fillStyle=-1===e?"#fff4":"#222",t.fillRect(377,8,115,24),t.strokeRect(377.5,8.5,114,23),t.fillStyle="#fff",t.font="12px monospace",t.textAlign="left",t.textBaseline="middle",t.fillText("Energy",16,21),t.fillText("Battery",139,21),t.fillText(`Resources: ${n.resources}`,254,21),t.textAlign="center",t.fillText("Launch!",434.5,21),t.fillStyle="#222",t.fillRect(0,720,500,80),t.strokeStyle="#fff",t.strokeRect(-1,720.5,502,23),t.fillStyle="#fff",t.font="12px monospace",t.textAlign="left",t.textBaseline="middle",t.fillText(lt(i),8,733.5),ot[i].draw(t,e)}(dt,ft))}(0);})()</script>
