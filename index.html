<meta charset="utf-8"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><style>canvas{image-rendering:pixelated;left:50%;max-height:49%;max-width:49%;position:fixed;top:50%;transform:translate(-50%,-50%)scale(2,2)}</style><body><script>(()=>{"use strict";const t=["backgroundObjects","objects","ground","healthBars","particles"],e=Object.fromEntries(t.map(((t,e)=>[t,e]))),n=new Map;let o=0;function i(t,i){return o+=1,n.set(o,[e[t],i]),o}function s(t,e){i("healthBars",(n=>{n.lineWidth=2,n.strokeStyle="#0f0",n.beginPath();for(const o of t()){if(o.health===o.maxHealth)continue;const{midX:t,y:i,width:s}=e(o);n.moveTo(t-s/2,i),n.lineTo(t-s/2+s*o.health/o.maxHealth,i)}n.stroke(),n.lineWidth=1}))}function a(t,e){return t+Math.random()*(e-t)}function r(t){return Math.floor(t/24)}function l(t,e,n=!1){const o=document.createElement("canvas");o.width=t,o.height=e;const i=o.getContext("2d");return i.imageSmoothingEnabled=n,[o,i]}let f=0;class c{x;y;constructor(t,e){this.x=t,this.y=e}add(t){return new c(this.x+t.x,this.y+t.y)}mul(t){return new c(this.x*t,this.y*t)}sub(t){return new c(this.x-t.x,this.y-t.y)}round(){return new c(Math.round(this.x),Math.round(this.y))}equal(t){return Boolean(t&&this.x===t.x&&this.y===t.y)}distance(t){return((this.x-t.x)**2+(this.y-t.y)**2)**.5}empty(){return isNaN(this.x)||isNaN(this.y)}within(t,e,n,o){return this.x>=t&&this.x<t+n&&this.y>=e&&this.y<e+o}ensureWithin(t,e,n,o){return new c(Math.min(t+n,Math.max(t,this.x)),Math.min(e+o,Math.max(e,this.y)))}static zero=new c(0,0);static empty=new c(NaN,NaN)}const h=y("base",10,((t,{x:e,y:n})=>{t.font="60px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ—¼",e+36,n+36+3)}),(()=>({})),(()=>({})),(t=>({midX:24*(t+1.5),width:72,height:72}))),d={solar:y("solar",2,((t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸŒž",e+12,n+12+1)}),(()=>({})),(()=>({}))),battery:y("battery",4,((t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ”‹",e+12,n+12+1)}),(()=>({energyLevel:0})),(()=>({}))),turret:y("turret",6,((t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ”«",e+12,n+12+1)}),(t=>({mid:new c(24*(t+.5),-12),count:1,range:1,power:1,targets:[]})),(({mid:t,count:e,range:n,power:o})=>{const i=function(t,e,n){const o=[];for(const i of W){const s=i.position.distance(t);if(s>n)continue;const a=o.findIndex((([t])=>s<t));a>=0?(o.splice(a,0,[s,i]),o.length>e&&o.pop()):o.length<e&&o.push([s,i])}return o.map((([,t])=>t))}(t,e,200*n);for(const t of i)t.health-=.02*o;return{targets:i}}))},u={base:h,...d},m={...d};function x(t,{x:e,y:n},{width:o,height:i}){t.strokeStyle="#fff",t.setLineDash([5,5]),t.lineDashOffset=Math.floor(f/60*-20),t.strokeRect(e+.5,n+.5,o-1,i-1),t.setLineDash([])}function y(t,e,n,o,i,s){return Object.assign((a=>({name:t,...o(a),draw:n,reduceState:i,midX:24*(a+.5),width:24,height:24,health:e,maxHealth:e,...s?.(a)})),{draw:n,width:24})}const p={type:"menu"},w=Object.entries(m),g=Object.fromEntries(w.map((([t])=>[t,S(t)]))),b={build:v("build",((t,e)=>{for(const[n,[o,{draw:i,width:s}]]of w.entries()){const a=8+72*n+.5,r=o===P,l="menuBuildObject"===e?.type&&e.name===o;t.fillStyle=r?"#fff":l?"#fff4":"#000",t.fillRect(a,736.5,64,56),t.strokeStyle="#fff",t.strokeRect(a,736.5,64,56),t.fillStyle=r?"#000":"#fff",t.font="12px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText(o,a+32,749.5),i(t,new c(a+(64-s)/2,760.5))}})),info:v("info",(t=>{const e=void 0!==O?j.get(O):void 0;t.font="12px monospace",t.textAlign="left",t.textBaseline="top",t.fillStyle="#fff",t.fillText(e?`Selected object: ${e}`:"select an object to see more details",8,736,484)}))},M=Object.keys(b);function v(t,e){const[,n]=l(1e3,1e3);return n.font="12px monospace",{draw:e,menuItem:{type:"tab",name:t},width:Math.round(n.measureText(t).width)+16-1}}function S(t){return{type:"menuBuildObject",name:t}}let k="build";function T(t){"tab"===t.type&&(k=t.name),"menuBuildObject"===t.type&&(P=t.name)}const j=new Map([[-1,u.base(-1)]]);let O,P,B=-1,N=1;function R(t,e,n){const o=n.within(24*e,-24,24,24);t.strokeStyle=o?"#fff":"#fff8",t.beginPath(),t.arc(24*(e+.5),-12,8,0,2*Math.PI),t.moveTo(24*(e+.3),-12),t.lineTo(24*(e+.7),-12),t.moveTo(24*(e+.5),24*-.3),t.lineTo(24*(e+.5),24*-.7),t.stroke()}function E({x:t,y:e}){const n=r(t),o=n>-1&&n<2?-1:n,i=j.get(o);if(e<=0&&e>=-(i?.height??24))return o}function I(t){void 0===t?(O=void 0,P=void 0):j.has(t)?(O=t,T({type:"tab",name:"info"})):P&&function(t,e){B=Math.min(t,B),N=Math.max(t,N);const n=m[e](t);j.set(t,n)}(t,P)}function L(){return[24*B-500,24*(N+1)-1+500]}const A=new Set;let X=0;const H=Math.PI/6,W=new Set,D=["#ccc","#aaa","#888","#666","#444"];function z(t=Math.floor(a(1,5)),e=a(-H,H),n=a(.5,1.5)/t,o=new c(a(...L())+-1300*Math.tan(e),-1300)){const s=q(t),r={mass:t,angle:e,speed:n,position:o,dPosition:new c(Math.sin(e),Math.cos(e)).mul(n),r:0,dr:Math.sign(Math.random()-.5)*a(.01,.04)/t,health:2**t,maxHealth:2**t,drawableHandle:i("objects",((t,{x1:e,y1:n,width:o,height:i})=>{if(r.position.within(e-s,n-s,o+2*s,i+2*s)){t.fillStyle="#666",t.strokeStyle="#aaa",t.beginPath();for(let e=0;e<r.vertexOffsets.length;e+=1){const n=r.vertexOffsets[e]*s,o=r.r+2*Math.PI*(e/r.vertexOffsets.length),i=r.position.x+Math.sin(o)*n,a=r.position.y+Math.cos(o)*n;0===e?t.moveTo(i,a):t.lineTo(i,a)}t.closePath(),t.fill(),t.stroke()}})),vertexOffsets:C(t)};W.add(r)}function Y(t){if(function(t){W.delete(t),n.delete(t.drawableHandle)}(t),function(t,e,n){const o=e**2*.02;for(let i=0;i<o;i+=1){const o=a(0,2*Math.PI),i=new c(Math.sin(o),Math.cos(o));A.add({position:t.add(i.mul(Math.random()*e)),dPosition:i.mul(1*Math.random()),life:60,color:n[Math.floor(Math.random()*n.length)]})}}(t.position,q(t.mass),D),1===t.mass)return;const e=t.angle;z(t.mass-1,e-Math.PI/12,t.speed*t.mass/(t.mass-1),t.position),z(t.mass-1,e+Math.PI/12,t.speed*t.mass/(t.mass-1),t.position)}function $(t){t.position.y<0||Y(t)}function q(t){return 24*t/2}function C(t){const e=2*Math.round(t)+3,n=[];for(let t=0;t<e;t+=1)n.push(a(.5,1));return n}const[F,G]=l(500,800);F.style.background="#000";let J,K,Q,U=new c(12,-160),V=1,Z=c.empty,_=c.empty,tt=c.empty,et=c.empty,nt=!1;function ot({clientX:t,clientY:e}={clientX:NaN,clientY:NaN}){const n=F.getBoundingClientRect();Z=new c(500/n.width*(t-n.left),800/n.height*(e-n.top)),_=Z.sub(new c(250,400)).mul(1/V).add(U),J=function(t){if(!(t.y<704))return function(t){let e=0;for(const n of M){if(t.within(e,704,b[n].width,24))return b[n].menuItem;e+=b[n].width}}(t)??function(t,e){if("build"===k)for(const[t,[n]]of w.entries())if(e.within(8+72*t+.5,736.5,64,56))return g[n]}(0,t)??p}(Z)}function it(t){U=t.sub(Z.sub(new c(250,400)).mul(1/V));const[e,n]=L();U=U.ensureWithin(e+251/V,401/V-1200,n-e-502/V,2400-802/V),U=new c(Math.round(U.x*V)/V,Math.round(U.y*V)/V)}function st(){tt=c.empty,et=c.empty,K=void 0,Q=void 0,nt=!1}function at(){G.resetTransform()}document.title="space-td";let rt=0;document.body.style.background="#49f",document.body.append(F),document.addEventListener("mousemove",(t=>{ot(t),!nt&&tt.distance(Z)>5&&(nt=!0),nt&&it(et)})),F.addEventListener("contextmenu",(t=>{t.preventDefault()})),F.addEventListener("wheel",(t=>{ot(t),J||function({deltaY:t}){V=Math.max(.5,Math.min(1.5,V-.08333333333333333*Math.sign(t))),it(_)}(t)})),F.addEventListener("mousedown",(t=>{t.preventDefault(),ot(t),J?Q=J:(tt=Z,et=_,K=E(_))})),document.addEventListener("mouseup",(t=>{ot(t),J&&J===Q?(I(void 0),T(J)):nt||K!==E(_)||I(K),st()})),document.addEventListener("visibilitychange",(()=>{Z=c.empty,_=c.empty,J=void 0,st()})),s((()=>W),(({mass:t,position:e})=>{const n=q(t);return{midX:e.x,y:e.y-n,width:2*n}})),i("objects",((t,{position:e,x1:n,x2:o})=>{const i=r(n),s=r(o);for(let n=i;n<=s;n+=-1===n?3:1){const o=j.get(n);if(!o){P&&R(t,n,e);continue}const i=new c(24*n,-o.height);o.draw(t,i);const s=e.within(i.x,i.y,o.width,o.height);(n===O||s)&&x(t,i,o)}})),i("backgroundObjects",(t=>{t.strokeStyle="#f00";for(const e of j.values())if("turret"===e.name){t.lineWidth=e.power/2,t.beginPath();for(const n of e.targets)t.moveTo(e.mid.x,e.mid.y),t.lineTo(n.position.x,n.position.y);t.stroke()}t.lineWidth=1})),s((()=>j.values()),(({midX:t,width:e,height:n})=>({midX:t,width:e-2,y:-n}))),i("ground",((t,{x1:e,x2:n})=>{const o=r(e),i=r(n);t.fillStyle="sienna";for(let e=o;e<=i;e+=-1===e?2:1)t.fillRect(24*e,0,24,24)})),i("particles",(t=>{for(const e of A){const n=Math.floor(e.life/60*16);t.fillStyle=`${e.color}${n.toString(16)}`,t.fillRect(e.position.x-1.5,e.position.y-1.5,3,3)}})),function e(o){requestAnimationFrame(e),o>=rt+15.666666666666668&&(rt=o,f+=1,function(){A.size>X&&(X=A.size);for(const t of A)t.life-=1,0===t.life&&A.delete(t),t.position=t.position.add(t.dPosition)}(),function(){Math.random()>.05||W.size>=80||z();for(const t of W)t.health<=0?Y(t):(t.position=t.position.add(t.dPosition),t.r+=t.dr,$(t))}(),function(){for(const t of j.values())Object.assign(t,t.reduceState(t,{}))}(),at(),G.clearRect(0,0,500,800),G.translate(250,400),G.scale(V,V),G.translate(-U.x,-U.y),function(e,o){const i=t.map((()=>[]));for(const[t,e]of n.values())i[t].push(e);for(const t of i)for(const n of t)n(e,o)}(G,{position:_,x1:U.x-251/V,y1:U.y-401/V,x2:U.x+251/V,y2:U.y+305/V,width:502/V,height:706/V}),at(),function(t,e){t.fillStyle="#000",t.fillRect(0,704,500,96),t.strokeStyle="#fff",t.strokeRect(.5,704.5,499,95),function(t,e){t.font="12px monospace",t.textAlign="left",t.textBaseline="middle";let n=0;for(const o of M){const i=o===k,s="tab"===e?.type&&e.name===o;t.fillStyle=i?"#fff":s?"#fff4":"#000",t.fillRect(n+.5,704.5,b[o].width,24),t.fillStyle=i?"#000":"#fff",t.fillText(o,n+8,717.5),t.strokeStyle="#fff",t.strokeRect(n+.5,704.5,b[o].width,24),n+=b[o].width}}(t,e),b[k].draw(t,e)}(G,J))}(0);})()</script>
