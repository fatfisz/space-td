<meta charset="utf-8"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><style>canvas{image-rendering:pixelated;left:50%;max-height:49%;max-width:49%;position:fixed;top:50%;transform:translate(-50%,-50%)scale(2,2)}</style><body><script>(()=>{"use strict";const t=["backgroundObjects","objects","ground","healthBars","particles"],e=Object.fromEntries(t.map(((t,e)=>[t,e]))),n=new Map;let o=0;function i(t,i){return o+=1,n.set(o,[e[t],i]),o}function s(t,e){i("healthBars",(n=>{n.lineWidth=2,n.strokeStyle="#0f0",n.beginPath();for(const o of t()){if(o.health>=o.maxHealth||o.health<0)continue;const{midX:t,y:i,width:s}=e(o);n.moveTo(t-s/2,i),n.lineTo(t-s/2+s*o.health/o.maxHealth,i)}n.stroke(),n.lineWidth=1}))}function a(t,e){return t+Math.random()*(e-t)}function r(t){return Math.floor(t/24)}function l(t,e,n=!1){const o=document.createElement("canvas");o.width=t,o.height=e;const i=o.getContext("2d");return i.imageSmoothingEnabled=n,[o,i]}let c=0;class f{x;y;constructor(t,e){this.x=t,this.y=e}add(t){return new f(this.x+t.x,this.y+t.y)}mul(t){return new f(this.x*t,this.y*t)}sub(t){return new f(this.x-t.x,this.y-t.y)}round(){return new f(Math.round(this.x),Math.round(this.y))}equal(t){return Boolean(t&&this.x===t.x&&this.y===t.y)}distance(t){return((this.x-t.x)**2+(this.y-t.y)**2)**.5}empty(){return isNaN(this.x)||isNaN(this.y)}within(t,e,n,o){return this.x>=t&&this.x<t+n&&this.y>=e&&this.y<e+o}ensureWithin(t,e,n,o){return new f(Math.min(t+n,Math.max(t,this.x)),Math.min(e+o,Math.max(e,this.y)))}static zero=new f(0,0);static empty=new f(NaN,NaN)}const h=y("base",10,((t,{x:e,y:n})=>{t.font="60px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ—¼",e+36,n+36+3)}),(()=>({})),(()=>({})),(t=>({midX:24*(t+1.5),width:72,height:72}))),d={solar:y("solar",2,((t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸŒž",e+12,n+12+1)}),(()=>({})),(()=>({}))),battery:y("battery",4,((t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ”‹",e+12,n+12+1)}),(()=>({energyLevel:0})),(()=>({}))),turret:y("turret",6,((t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ”«",e+12,n+12+1)}),(t=>({mid:new f(24*(t+.5),-12),count:1,range:1,power:1,targets:[]})),(({mid:t,count:e,range:n,power:o})=>{const i=function(t,e,n){const o=[];for(const i of z){const s=i.position.distance(t);if(s>n)continue;const a=o.findIndex((([t])=>s<t));a>=0?(o.splice(a,0,[s,i]),o.length>e&&o.pop()):o.length<e&&o.push([s,i])}return o.map((([,t])=>t))}(t,e,200*n);for(const t of i)t.health-=.02*o;return{targets:i}}))},u={base:h,...d},m={...d};function p(t,{x:e,y:n},{width:o,height:i}){t.strokeStyle="#fff",t.setLineDash([5,5]),t.lineDashOffset=Math.floor(c/60*-20),t.strokeRect(e+.5,n+.5,o-1,i-1),t.setLineDash([])}function y(t,e,n,o,i,s){return Object.assign((a=>({name:t,...o(a),draw:n,reduceState:i,midX:24*(a+.5),width:24,height:24,health:e,maxHealth:e,...s?.(a)})),{draw:n,width:24})}const x={type:"menu"},w=Object.entries(m),g=Object.fromEntries(w.map((([t])=>[t,S(t)]))),b={build:v("build",((t,e)=>{for(const[n,[o,{draw:i,width:s}]]of w.entries()){const a=8+72*n+.5,r=o===R,l="menuBuildObject"===e?.type&&e.name===o;t.fillStyle=r?"#fff":l?"#fff4":"#000",t.fillRect(a,736.5,64,56),t.strokeStyle="#fff",t.strokeRect(a,736.5,64,56),t.fillStyle=r?"#000":"#fff",t.font="12px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText(o,a+32,749.5),i(t,new f(a+(64-s)/2,760.5))}})),info:v("info",(t=>{const e=void 0!==N?O.get(N):void 0;t.font="12px monospace",t.textAlign="left",t.textBaseline="top",t.fillStyle="#fff",t.fillText(e?`Selected object: ${e}`:"select an object to see more details",8,736,484)}))},M=Object.keys(b);function v(t,e){const[,n]=l(1e3,1e3);return n.font="12px monospace",{draw:e,menuItem:{type:"tab",name:t},width:Math.round(n.measureText(t).width)+16-1}}function S(t){return{type:"menuBuildObject",name:t}}let k="build";function T(t){"tab"===t.type&&(k=t.name),"menuBuildObject"===t.type&&(R=t.name)}const j=new Set;let P=0;function B(t,e,n,o=!1){const i=e**2*(o?.08:.02);for(let o=0;o<i;o+=1){const o=a(0,2*Math.PI),i=new f(Math.sin(o),Math.cos(o));j.add({position:t.add(i.mul(Math.random()*e)),dPosition:i.mul(1*Math.random()),life:60,color:n[Math.floor(Math.random()*n.length)]})}}const O=new Map([[-1,u.base(-1)]]);let N,R,A=-1,E=1;const I=["#f00","#fc0","#fa0","#f80","#f60","#f40","#ff0"];function L(t,e,n){const o=n.within(24*e,-24,24,24);t.strokeStyle=o?"#fff":"#fff8",t.beginPath(),t.arc(24*(e+.5),-12,8,0,2*Math.PI),t.moveTo(24*(e+.3),-12),t.lineTo(24*(e+.7),-12),t.moveTo(24*(e+.5),24*-.3),t.lineTo(24*(e+.5),24*-.7),t.stroke()}function X({x:t,y:e}){const n=D(r(t)),o=O.get(n);if(e<=0&&e>=-(o?.height??24))return n}function H(t){void 0===t?(N=void 0,R=void 0):O.has(t)?(N=t,T({type:"tab",name:"info"})):R&&function(t,e){A=Math.min(t,A),E=Math.max(t,E);const n=m[e](t);O.set(t,n)}(t,R)}function W(){return[24*A-500,24*(E+1)-1+500]}function D(t){return t>-1&&t<2?-1:t}const V=Math.PI/6,z=new Set,Y=["#ccc","#aaa","#888","#666","#444"];function $(t=Math.floor(a(1,5)),e=a(-V,V),n=a(.5,1.5)/t,o=new f(a(...W())+-1300*Math.tan(e),-1300)){const s={mass:t,radius:24*t/2,angle:e,speed:n,position:o,dPosition:new f(Math.sin(e),Math.cos(e)).mul(n),r:0,dr:Math.sign(Math.random()-.5)*a(.01,.04)/t,health:2**t,maxHealth:2**t,drawableHandle:i("objects",((t,{x1:e,y1:n,width:o,height:i})=>{if(!s.position.within(e-s.radius,n-s.radius,o+2*s.radius,i+2*s.radius))return;t.fillStyle="#666",t.strokeStyle="#aaa",t.beginPath();let a=!0;for(const{x:e,y:n}of s.computedVertices)a?(a=!1,t.moveTo(e,n)):t.lineTo(e,n);t.closePath(),t.fill(),t.stroke()})),vertexOffsets:G(t),computedVertices:[]};C(s),z.add(s)}function q(t,e=!0){if(function(t){z.delete(t),n.delete(t.drawableHandle)}(t),B(t.position,t.radius,Y),1===t.mass||!e)return;const o=t.angle;$(t.mass-1,o-Math.PI/12,t.speed*t.mass/(t.mass-1),t.position),$(t.mass-1,o+Math.PI/12,t.speed*t.mass/(t.mass-1),t.position)}function C(t){t.computedVertices=t.vertexOffsets.map(((e,n,{length:o})=>{const i=t.r+2*Math.PI*(n/o);return new f(t.position.x+Math.sin(i)*e*t.radius,t.position.y+Math.cos(i)*e*t.radius)}))}function F(t){const e=function(t){for(const e of t){const t=D(r(e.x)),n=O.get(t);if(n&&e.y<0&&e.y>-n.height)return n}}(t.computedVertices);if(e)return e.health-=function(t){const e=t.health/t.maxHealth;return t.mass**2*e+(t.mass-1)**2*(1-e)}(t),void q(t,!1);t.computedVertices.some((({y:t})=>t>0))&&q(t,!1)}function G(t){const e=2*Math.round(t)+3,n=[];for(let t=0;t<e;t+=1)n.push(a(.5,1));return n}const[J,K]=l(500,800);J.style.background="#000";let Q,U,Z,_=new f(12,-160),tt=1,et=f.empty,nt=f.empty,ot=f.empty,it=f.empty,st=!1;function at({clientX:t,clientY:e}={clientX:NaN,clientY:NaN}){const n=J.getBoundingClientRect();et=new f(500/n.width*(t-n.left),800/n.height*(e-n.top)),nt=et.sub(new f(250,400)).mul(1/tt).add(_),Q=function(t){if(!(t.y<704))return function(t){let e=0;for(const n of M){if(t.within(e,704,b[n].width,24))return b[n].menuItem;e+=b[n].width}}(t)??function(t,e){if("build"===k)for(const[t,[n]]of w.entries())if(e.within(8+72*t+.5,736.5,64,56))return g[n]}(0,t)??x}(et)}function rt(t){_=t.sub(et.sub(new f(250,400)).mul(1/tt));const[e,n]=W();_=_.ensureWithin(e+251/tt,401/tt-1200,n-e-502/tt,2400-802/tt),_=new f(Math.round(_.x*tt)/tt,Math.round(_.y*tt)/tt)}function lt(){ot=f.empty,it=f.empty,U=void 0,Z=void 0,st=!1}function ct(){K.resetTransform()}document.title="space-td";let ft=0;document.body.style.background="#49f",document.body.append(J),document.addEventListener("mousemove",(t=>{at(t),!st&&ot.distance(et)>5&&(st=!0),st&&rt(it)})),J.addEventListener("contextmenu",(t=>{t.preventDefault()})),J.addEventListener("wheel",(t=>{at(t),Q||function({deltaY:t}){tt=Math.max(.5,Math.min(1.5,tt-.08333333333333333*Math.sign(t))),rt(nt)}(t)})),J.addEventListener("mousedown",(t=>{t.preventDefault(),at(t),Q?Z=Q:(ot=et,it=nt,U=X(nt))})),document.addEventListener("mouseup",(t=>{at(t),Q&&Q===Z?(H(void 0),T(Q)):st||U!==X(nt)||H(U),lt()})),document.addEventListener("visibilitychange",(()=>{et=f.empty,nt=f.empty,Q=void 0,lt()})),s((()=>z),(({radius:t,position:{x:e,y:n}})=>({midX:e,y:n-t,width:2*t}))),i("objects",((t,{position:e,x1:n,x2:o})=>{const i=r(n),s=r(o);for(let n=i;n<=s;n+=-1===n?3:1){const o=O.get(n);if(!o){R&&L(t,n,e);continue}const i=new f(24*n,-o.height);o.health<=0&&(t.globalAlpha=.5),o.draw(t,i),o.health<=0&&(t.globalAlpha=1);const s=e.within(i.x,i.y,o.width,o.height);(n===N||s)&&p(t,i,o)}})),i("backgroundObjects",(t=>{t.strokeStyle="#f00";for(const e of O.values())if("turret"===e.name){t.lineWidth=e.power/2,t.beginPath();for(const n of e.targets)t.moveTo(e.mid.x,e.mid.y),t.lineTo(n.position.x,n.position.y);t.stroke()}t.lineWidth=1})),s((()=>O.values()),(({midX:t,width:e,height:n})=>({midX:t,width:e-2,y:-n}))),i("ground",((t,{x1:e,x2:n})=>{const o=r(e),i=r(n);t.fillStyle="sienna";for(let e=o;e<=i;e+=-1===e?2:1)t.fillRect(24*e,0,24,24)})),i("particles",(t=>{for(const e of j){const n=Math.floor(e.life/60*16);t.fillStyle=`${e.color}${n.toString(16)}`,t.fillRect(e.position.x-1.5,e.position.y-1.5,3,3)}})),function e(o){requestAnimationFrame(e),o>=ft+15.666666666666668&&(ft=o,c+=1,function(){j.size>P&&(P=j.size);for(const t of j)t.life-=1,0===t.life&&j.delete(t),t.position=t.position.add(t.dPosition)}(),function(){Math.random()>.05||z.size>=80||$();for(const t of z)t.health<=0?q(t):(t.position=t.position.add(t.dPosition),t.r+=t.dr,C(t),F(t))}(),function(){for(const[t,e]of O.entries())e.health>0?Object.assign(e,e.reduceState(e,{})):(B(new f(e.midX,-e.height/2),e.height/2,I,!0),O.delete(t))}(),ct(),K.clearRect(0,0,500,800),K.translate(250,400),K.scale(tt,tt),K.translate(-_.x,-_.y),function(e,o){const i=t.map((()=>[]));for(const[t,e]of n.values())i[t].push(e);for(const t of i)for(const n of t)n(e,o)}(K,{position:nt,x1:_.x-251/tt,y1:_.y-401/tt,x2:_.x+251/tt,y2:_.y+305/tt,width:502/tt,height:706/tt}),ct(),function(t,e){t.fillStyle="#000",t.fillRect(0,704,500,96),t.strokeStyle="#fff",t.strokeRect(.5,704.5,499,95),function(t,e){t.font="12px monospace",t.textAlign="left",t.textBaseline="middle";let n=0;for(const o of M){const i=o===k,s="tab"===e?.type&&e.name===o;t.fillStyle=i?"#fff":s?"#fff4":"#000",t.fillRect(n+.5,704.5,b[o].width,24),t.fillStyle=i?"#000":"#fff",t.fillText(o,n+8,717.5),t.strokeStyle="#fff",t.strokeRect(n+.5,704.5,b[o].width,24),n+=b[o].width}}(t,e),b[k].draw(t,e)}(K,Q))}(0);})()</script>
