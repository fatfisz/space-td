<meta charset="utf-8"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><style>canvas{image-rendering:pixelated;left:50%;max-height:49%;max-width:49%;position:fixed;top:50%;transform:translate(-50%,-50%)scale(2,2)}</style><body><script>(()=>{"use strict";const t=["backgroundObjects","objects","ground","decorative","particles"],e=Object.fromEntries(t.map(((t,e)=>[t,e]))),n=new Map;let o=0;function i(t,i){return o+=1,n.set(o,[e[t],i]),o}function a(t,e){return t+Math.random()*(e-t)}function r(t){return Math.floor(t/24)}function s(t,e){return`${t},${e}`}function d(t){return t.split(",").map((t=>+t))}class l{x;y;constructor(t,e){this.x=t,this.y=e}add(t){return new l(this.x+t.x,this.y+t.y)}mul(t){return new l(this.x*t,this.y*t)}sub(t){return new l(this.x-t.x,this.y-t.y)}distance(t){return((this.x-t.x)**2+(this.y-t.y)**2)**.5}within(t,e,n,o){return this.x>=t&&this.x<t+n&&this.y>=e&&this.y<e+o}ensureWithin(t,e,n,o){return new l(Math.min(t+n,Math.max(t,this.x)),Math.min(e+o,Math.max(e,this.y)))}static zero=new l(0,0);static empty=new l(NaN,NaN)}const c=new Set(["0,0"]),f=new Set;function h(t,e,n){if(n<=0)return;const o=s(e,n);c.has(o)||t.has(o)||t.add(o)}let u=0;const m=p({name:"base",maxHealth:20,getState:()=>({}),upgrades:{armor:1},extra:{width:72,height:72},draw:(t,{x:e,y:n})=>{t.font="60px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("🗼",e+36,n+36+3)}}),x={solar:p({name:"solar",maxHealth:2,getState:()=>({}),upgrades:{efficiency:1,armor:1},draw:(t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("🌞",e+12,n+12+1)}}),battery:p({name:"battery",maxHealth:4,getState:()=>({energy:0}),upgrades:{storage:1,armor:1},draw:(t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("🔋",e+12,n+12+1)}}),turret:p({name:"turret",maxHealth:8,getState:()=>({targets:[]}),upgrades:{count:1,range:1,power:1,armor:1},draw:(t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("🔫",e+12,n+12+1)}}),drill:p({name:"drill",maxHealth:1/0,getState:()=>({ticksLeft:120}),upgrades:{},extra:{addParticlesWhenDestructing:!1},draw:(t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("⛏️",e+12,n+12+1)}})},g={base:m,...x};function y(t,{x:e,y:n},{width:o,height:i}){t.strokeStyle="#fff",t.setLineDash([5,5]),t.lineDashOffset=Math.floor(u/60*-20),t.strokeRect(e+.5,n+.5,o-1,i-1),t.setLineDash([])}function p({name:t,maxHealth:e,getState:n,upgrades:o,extra:i,draw:a}){const r={name:t,width:24,height:24,health:e,maxHealth:e,draw:a,...i};return{get:(t,e)=>{const i={mid:new l(24*t+r.width/2,24*(e+1)-r.height/2),armor:1/0,upgrade:function(t){i[t]=Math.min(i[t]+1,3)},...o,...r,...n?.(t,e)};return i},...r}}const w=new Set;let v=0;function M(t,e,n,o=!1){const i=e**2*(o?.08:.04);for(let o=0;o<i;o+=1){const o=a(0,2*Math.PI),i=new l(Math.sin(o),Math.cos(o));w.add({mid:t.add(i.mul(Math.random()*e)),dMid:i.mul(1*Math.random()),life:60,color:n[Math.floor(Math.random()*n.length)]})}}function b(t,e,n){i("decorative",(o=>{o.lineWidth=2,o.strokeStyle=t,o.beginPath();for(const t of e()){const{value:e,mid:i,offsetY:a,width:r}=n(t);e<0||(o.moveTo(i.x-r/2,i.y+a),o.lineTo(i.x-r/2+r*e,i.y+a))}o.stroke(),o.lineWidth=1}))}const S=new Map([[s(-1,-1),g.base.get(-1,-1)]]),k=["#fc0","#fa0","#f80","#f60","#f40","#ff0"],T=new Set,P=new Set,H=new Set,L=new Set;let A,B,E=-1,$=1,N=1;function R(){if(!B)return[];if("drill"===B)return function(){const t=new Set;for(const e of c){const[n,o]=d(e);h(t,n-1,o),h(t,n+1,o),h(t,n,o-1),h(t,n,o+1)}return[...t].map((t=>new l(...d(t))))}().filter((t=>!S.has(s(t.x,t.y))&&!S.has(s(t.x,t.y-1))));const[t,e]=z(),n=[];for(let o=t;o<=e;o+=1)(o<-1||o>=2)&&!S.has(s(o,-1))&&n.push(new l(o,-1));return"battery"===B?[...n,...(1===c.size?[]:[...c].filter((t=>{const[e,n]=d(t);return!c.has(s(e,n+1))})).map((t=>new l(...d(t))))).filter((t=>!S.has(s(t.x,t.y))))]:n}function W(t,e,n){const o=n.within(24*e.x,24*e.y,24,24);t.strokeStyle=o?"#fff":"#fff8",t.beginPath(),t.arc(24*(e.x+.5),24*(e.y+.5),8,0,2*Math.PI),t.moveTo(24*(e.x+.3),24*(e.y+.5)),t.lineTo(24*(e.x+.7),24*(e.y+.5)),t.moveTo(24*(e.x+.5),24*(e.y+.3)),t.lineTo(24*(e.x+.5),24*(e.y+.7)),t.stroke()}function Y({x:t,y:e}){const n=V(r(t),r(e));if(S.get(n)||R().some((t=>s(t.x,t.y)===n)))return n}function j(t){void 0===t?(A=void 0,B=void 0):S.has(t)?("drill"!==S.get(t).name&&(A=t),B=void 0):B&&function(t,e){const[n,o]=d(t);E=Math.min(n,E),$=Math.max(n,$);const i=x[e].get(n,o);S.set(t,i),"solar"===i.name?T.add(i):"battery"===i.name?P.add(i):"turret"===i.name?H.add(i):"drill"===i.name&&(L.add(i),function(t){f.add(t)}(t))}(t,B)}function D(t,e){(e.addParticlesWhenDestructing??1)&&M(e.mid,e.height/2,k,!0),S.delete(t),A===t&&(A=void 0),"solar"===e.name?T.delete(e):"battery"===e.name?P.delete(e):"turret"===e.name?H.delete(e):"drill"===e.name&&(L.delete(e),function(t){f.delete(t),c.add(t)}(t))}function I(){return void 0!==A?S.get(A):void 0}function O(){return B}function z(){return[24*E-500,24*($+1)-1+500]}function V(t,e){return t>=-1&&t<2&&e>-4&&e<=-1?s(-1,-1):s(t,e)}function C(t){return 1+Math.round(10*Math.log(t))/10}const X=Math.PI/6,q=new Set,F=["#eee","#ccc","#aaa","#888","#666","#444"];function G(t=Math.floor(a(1,5)),e=a(-X,X),n=a(.5,1.5)/t,o=new l(a(...z())+-1300*Math.tan(e),-1300)){const r={mass:t,radius:24*t/2,angle:e,speed:n,mid:o,dMid:new l(Math.sin(e),Math.cos(e)).mul(n),r:0,dr:Math.sign(Math.random()-.5)*a(.01,.04)/t,health:2**t,maxHealth:2**t,drawableHandle:i("objects",((t,{x1:e,y1:n,width:o,height:i})=>{if(!r.mid.within(e-r.radius,n-r.radius,o+2*r.radius,i+2*r.radius))return;t.fillStyle="#666",t.strokeStyle="#aaa",t.beginPath();let a=!0;for(const{x:e,y:n}of r.computedVertices)a?(a=!1,t.moveTo(e,n)):t.lineTo(e,n);t.closePath(),t.fill(),t.stroke()})),vertexOffsets:U(t),computedVertices:[]};K(r),q.add(r)}function J(t){if(function(t){q.delete(t),n.delete(t.drawableHandle)}(t),M(t.mid,t.radius,F),1===t.mass)return;const e=t.angle;G(t.mass-1,e-Math.PI/12,t.speed,t.mid),G(t.mass-1,e+Math.PI/12,t.speed,t.mid)}function K(t){t.computedVertices=t.vertexOffsets.map(((e,n,{length:o})=>{const i=t.r+2*Math.PI*(n/o);return new l(t.mid.x+Math.sin(i)*e*t.radius,t.mid.y+Math.cos(i)*e*t.radius)}))}function Q(t){const e=function(t){for(const e of t){const t=V(r(e.x),r(e.y)),n=S.get(t);if(n&&e.y<=0&&e.y>=-n.height)return n}}(t.computedVertices);if(e)return e.health-=function(t){const e=t.health/t.maxHealth;return t.mass**2*e+(t.mass-1)**2*(1-e)}(t)*(1-.25*(e.armor-1)),void J(t);t.computedVertices.some((({y:t})=>t>0))&&J(t)}function U(t){const e=2*Math.round(t)+3,n=[];for(let t=0;t<e;t+=1)n.push(a(.5,1));return n}function Z(t,e,n){const o=[];for(const i of q){const a=i.mid.distance(t);if(a>n)continue;const r=o.findIndex((([t])=>a<t));r>=0?(o.splice(r,0,[a,i]),o.length>e&&o.pop()):o.length<e&&o.push([a,i])}return o.map((([,t])=>t))}const _={build:et(Object.values(x),((t,{left:e,active:n},{name:o,width:i,draw:a})=>{t.font="12px monospace",t.fillStyle=n?"#000":"#fff",t.textAlign="center",t.textBaseline="middle",t.fillText(o,e+40,757),a(t,new l(e+(80-i)/2,768))}),(({name:t})=>{B=t}),(()=>{const t=O();return t&&x[t]})),"upgrade base":nt(["armor"]),"upgrade solar":nt(["efficiency","armor"]),"upgrade battery":nt(["storage","armor"]),"upgrade turret":nt(["power","range","count","armor"])};function tt(){const t=I()?.name;return t?`upgrade ${t}`:"build"}function et(t,e,n,o){return{options:t,draw:(n,i)=>{for(const[a,r]of t.entries()){const t=80*a,s=o?.()===r,d=a===i;n.fillStyle=s?"#fff":d?"#fff4":"#222",n.fillRect(t,744,80,56),n.strokeStyle="#fff",n.beginPath(),n.moveTo(t+80-.5,744),n.lineTo(t+80-.5,800),n.stroke(),e(n,{left:t,active:s,hover:d},r)}},optionClick:n}}function nt(t){return et(t,((t,{left:e,active:n},o)=>{t.font="12px monospace",t.fillStyle=n?"#000":"#fff",t.textAlign="center",t.textBaseline="middle",t.fillText(o,e+40,757);const i=I()[o];t.fillText(3===i?`maxed (${i})`:`${i} 🠖 ${i+1}`,e+40,781)}),(t=>{I().upgrade(t)}))}const[ot,it]=function(t,e,n=!1){const o=document.createElement("canvas");o.width=t,o.height=e;const i=o.getContext("2d");return i.imageSmoothingEnabled=n,[o,i]}(500,800);ot.style.background="#000";let at,rt,st=new l(12,-160),dt=1,lt=l.empty,ct=l.empty,ft=l.empty,ht=l.empty,ut=!1,mt=!1;function xt({clientX:t,clientY:e}={clientX:NaN,clientY:NaN}){const n=ot.getBoundingClientRect();lt=new l(500/n.width*(t-n.left),800/n.height*(e-n.top)),ct=lt.sub(new l(250,400)).mul(1/dt).add(st),at=function(t){if(!(t.y<720)){for(let e=0;e<500/88;e+=1)if(t.within(80*e,744,80,56))return e;return-1}}(lt)}function gt(t){st=t.sub(lt.sub(new l(250,400)).mul(1/dt));const[e,n]=z();st=st.ensureWithin(e+251/dt,401/dt-1200,n-e-502/dt,2400-802/dt),st=new l(Math.round(st.x*dt)/dt,Math.round(st.y*dt)/dt)}function yt(){ft=l.empty,ht=l.empty,rt=void 0,ut=!1,mt=!1}function pt(){it.resetTransform()}document.title="space-td";let wt=0;document.body.style.background="#49f",document.body.append(ot),document.addEventListener("mousemove",(t=>{xt(t),!ut&&ft.distance(lt)>5&&(ut=!0),ut&&gt(ht)})),ot.addEventListener("contextmenu",(t=>{t.preventDefault()})),ot.addEventListener("wheel",(t=>{xt(t),void 0===at&&function({deltaY:t}){dt=Math.max(.5,Math.min(1.5,dt-.08333333333333333*Math.sign(t))),gt(ct)}(t)})),ot.addEventListener("mousedown",(t=>{t.preventDefault(),xt(t),void 0!==at?(mt=!0,function(t){const e=tt();"build"===tt()&&j(void 0),void 0!==t&&t>=0&&t<_[e].options.length&&_[e].optionClick(_[e].options[t])}(at)):(ft=lt,ht=ct,rt=Y(ct))})),document.addEventListener("mouseup",(t=>{xt(t),ut||mt||rt!==Y(ct)||j(rt),yt()})),document.addEventListener("visibilitychange",(()=>{lt=l.empty,ct=l.empty,at=void 0,yt()})),b("#0f0",(()=>q),(({radius:t,mid:e,health:n,maxHealth:o})=>({mid:e,offsetY:-t,width:2*t,value:n/o}))),i("objects",((t,{position:e})=>{for(const n of S.values()){const o=r(n.mid.x-n.width/2),i=r(n.mid.y-n.height/2),a=new l(24*o,24*i);n.draw(t,a);const d=e.within(a.x,a.y,n.width,n.height);(s(o,-1)===A||d)&&y(t,a,n)}})),i("decorative",((t,e)=>{for(const n of R())W(t,n,e.position)})),i("backgroundObjects",(t=>{const e=Math.floor(15*N).toString(16);t.strokeStyle=`#f00${e}`;for(const e of S.values())if("turret"===e.name){t.lineWidth=e.power/2,t.beginPath();for(const n of e.targets)t.moveTo(e.mid.x,e.mid.y),t.lineTo(n.mid.x,n.mid.y);t.stroke()}t.lineWidth=1})),b("#0f0",(()=>S.values()),(({mid:t,width:e,height:n,health:o,maxHealth:i})=>({mid:t,width:e-2,offsetY:-n/2-4,value:o/i}))),b("#66f",(()=>P),(({mid:t,width:e,height:n,energy:o,storage:i})=>({mid:t,width:e-2,offsetY:-n/2-1,value:o/i}))),b("#f00",(()=>L),(({mid:t,width:e,height:n,ticksLeft:o})=>({mid:t,width:e-2,offsetY:-n/2-1,value:(120-o)/120}))),i("ground",((t,{x1:e,y1:n,x2:o,y2:i})=>{const a=r(e),d=Math.max(r(n),0),l=r(o),h=r(i);t.fillStyle="sienna";for(let e=d;e<=h;e+=1)for(let n=a;n<=l;n+=1){const o=s(n,e);c.has(o)||f.has(o)||t.fillRect(24*n,24*e,24,24)}})),i("particles",(t=>{for(const e of w){const n=Math.floor(e.life/60*16);t.fillStyle=`${e.color}${n.toString(16)}`,t.fillRect(e.mid.x-1.5,e.mid.y-1.5,3,3)}})),function e(o){requestAnimationFrame(e),o>=wt+15.666666666666668&&(wt=o,u+=1,function(){w.size>v&&(v=w.size);for(const t of w)t.life-=1,0===t.life&&w.delete(t),t.mid=t.mid.add(t.dMid)}(),function(){Math.random()>.05||q.size>=80||G();for(const t of q)t.health<=0?J(t):(t.mid=t.mid.add(t.dMid),t.r+=t.dr,K(t),Q(t))}(),function(){for(const[t,e]of S.entries())e.health<=0&&D(t,e);let t=0;for(const{efficiency:e}of T)t+=10*e*1;let e=0;for(const{energy:t}of P)e+=1e5*t;let n=0;for(const t of H){const{mid:e,count:o,range:i,power:a}=t;t.targets=Z(e,o,200*i),n+=t.targets.length*C(o)*C(a)*15,n+=1}n+=5*L.size;const o=Math.min(n,t+e);N=o/n;for(const t of H){const{targets:e,power:n}=t;for(const t of e)t.health-=.02*n*N}for(const t of L)t.ticksLeft-=N,t.ticksLeft<=0&&D(s(r(t.mid.x),r(t.mid.y)),t);let i=(t-o)/1e5;if(i>0){const t=[...P];for(let e=0;e<t.length;e+=1){const n=t[e],o=Math.min(i/(t.length-e),n.storage-n.energy);n.energy+=o,i-=o}}else if(i<0){const t=[...P].reverse();for(let e=0;e<t.length;e+=1){const n=t[e],o=Math.max(i/(t.length-e),-n.energy);n.energy+=o,i-=o}}}(),pt(),it.clearRect(0,0,500,800),it.translate(250,400),it.scale(dt,dt),it.translate(-st.x,-st.y),function(e,o){const i=t.map((()=>[]));for(const[t,e]of n.values())i[t].push(e);for(const t of i)for(const n of t)n(e,o)}(it,{position:ct,x1:st.x-251/dt,y1:st.y-401/dt,x2:st.x+251/dt,y2:st.y+321/dt,width:502/dt,height:722/dt}),pt(),function(t,e){const n=tt();t.fillStyle="#222",t.fillRect(0,720,500,80),t.strokeStyle="#fff",t.strokeRect(-1,720.5,502,23),t.fillStyle="#fff",t.font="12px monospace",t.textAlign="left",t.textBaseline="middle",t.fillText(n,8,733.5),_[n].draw(t,e)}(it,at))}(0);})()</script>
