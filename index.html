<meta charset="utf-8"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><style>canvas{image-rendering:pixelated;left:50%;max-height:49%;max-width:49%;position:fixed;top:50%;transform:translate(-50%,-50%)scale(2,2)}</style><body><script>(()=>{"use strict";const t=["backgroundObjects","objects","ground","statusBars","particles"],e=Object.fromEntries(t.map(((t,e)=>[t,e]))),n=new Map;let o=0;function i(t,i){return o+=1,n.set(o,[e[t],i]),o}function s(t,e){return t+Math.random()*(e-t)}function a(t){return Math.floor(t/24)}let r=0;class l{x;y;constructor(t,e){this.x=t,this.y=e}add(t){return new l(this.x+t.x,this.y+t.y)}mul(t){return new l(this.x*t,this.y*t)}sub(t){return new l(this.x-t.x,this.y-t.y)}round(){return new l(Math.round(this.x),Math.round(this.y))}equal(t){return Boolean(t&&this.x===t.x&&this.y===t.y)}distance(t){return((this.x-t.x)**2+(this.y-t.y)**2)**.5}empty(){return isNaN(this.x)||isNaN(this.y)}within(t,e,n,o){return this.x>=t&&this.x<t+n&&this.y>=e&&this.y<e+o}ensureWithin(t,e,n,o){return new l(Math.min(t+n,Math.max(t,this.x)),Math.min(e+o,Math.max(e,this.y)))}static zero=new l(0,0);static empty=new l(NaN,NaN)}const c=m("base",10,((t,{x:e,y:n})=>{t.font="60px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ—¼",e+36,n+36+3)}),(()=>({})),{width:72,height:72}),f={solar:m("solar",2,((t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸŒž",e+12,n+12+1)}),(()=>({efficiency:1}))),battery:m("battery",4,((t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ”‹",e+12,n+12+1)}),(()=>({storage:1,energy:0}))),turret:m("turret",6,((t,{x:e,y:n})=>{t.font="20px monospace",t.textAlign="center",t.textBaseline="middle",t.fillText("ðŸ”«",e+12,n+12+1)}),(t=>({mid:new l(24*(t+.5),-12),count:1,range:1,power:1,targets:[]})))},h={base:c,...f},d={...f};function u(t,{x:e,y:n},{width:o,height:i}){t.strokeStyle="#fff",t.setLineDash([5,5]),t.lineDashOffset=Math.floor(r/60*-20),t.strokeRect(e+.5,n+.5,o-1,i-1),t.setLineDash([])}function m(t,e,n,o,i){const s={name:t,draw:n,width:24,height:24,health:e,maxHealth:e,...i};return{get:t=>({midX:24*t+s.width/2,...s,...o?.(t)}),...s}}const y=new Set;let g=0;function p(t,e,n,o=!1){const i=e**2*(o?.08:.04);for(let o=0;o<i;o+=1){const o=s(0,2*Math.PI),i=new l(Math.sin(o),Math.cos(o));y.add({position:t.add(i.mul(Math.random()*e)),dPosition:i.mul(1*Math.random()),life:60,color:n[Math.floor(Math.random()*n.length)]})}}function x(t,e,n){i("statusBars",(o=>{o.lineWidth=2,o.strokeStyle=t,o.beginPath();for(const t of e()){const{value:e,midX:i,y:s,width:a}=n(t);e<0||(o.moveTo(i-a/2,s),o.lineTo(i-a/2+a*e,s))}o.stroke(),o.lineWidth=1}))}const w=new Map([[-1,h.base.get(-1)]]),M=["#fc0","#fa0","#f80","#f60","#f40","#ff0"],v=new Set,b=new Set,S=new Set;let k,T,P=-1,N=1,B=1;function X(t,e,n){const o=n.within(24*e,-24,24,24);t.strokeStyle=o?"#fff":"#fff8",t.beginPath(),t.arc(24*(e+.5),-12,8,0,2*Math.PI),t.moveTo(24*(e+.3),-12),t.lineTo(24*(e+.7),-12),t.moveTo(24*(e+.5),24*-.3),t.lineTo(24*(e+.5),24*-.7),t.stroke()}function A({x:t,y:e}){const n=H(a(t)),o=w.get(n);if(e<=0&&e>=-(o?.height??24))return n}function E(t){void 0===t?(k=void 0,T=void 0):w.has(t)?k=t:T&&function(t,e){P=Math.min(t,P),N=Math.max(t,N);const n=d[e].get(t);w.set(t,n),"solar"===n.name?v.add(n):"battery"===n.name?b.add(n):"turret"===n.name&&S.add(n)}(t,T)}function R(t,e){p(new l(e.midX,-e.height/2),e.height/2,M,!0),w.delete(t),"solar"===e.name?v.delete(e):"battery"===e.name?b.delete(e):"turret"===e.name&&S.delete(e)}function L(){return T}function j(){return[24*P-500,24*(N+1)-1+500]}function H(t){return t>-1&&t<2?-1:t}const I=Math.PI/6,O=new Set,W=["#eee","#ccc","#aaa","#888","#666","#444"];function z(t=Math.floor(s(1,5)),e=s(-I,I),n=s(.5,1.5)/t,o=new l(s(...j())+-1300*Math.tan(e),-1300)){const a={mass:t,radius:24*t/2,angle:e,speed:n,position:o,dPosition:new l(Math.sin(e),Math.cos(e)).mul(n),r:0,dr:Math.sign(Math.random()-.5)*s(.01,.04)/t,health:2**t,maxHealth:2**t,drawableHandle:i("objects",((t,{x1:e,y1:n,width:o,height:i})=>{if(!a.position.within(e-a.radius,n-a.radius,o+2*a.radius,i+2*a.radius))return;t.fillStyle="#666",t.strokeStyle="#aaa",t.beginPath();let s=!0;for(const{x:e,y:n}of a.computedVertices)s?(s=!1,t.moveTo(e,n)):t.lineTo(e,n);t.closePath(),t.fill(),t.stroke()})),vertexOffsets:Y(t),computedVertices:[]};V(a),O.add(a)}function D(t){if(function(t){O.delete(t),n.delete(t.drawableHandle)}(t),p(t.position,t.radius,W),1===t.mass)return;const e=t.angle;z(t.mass-1,e-Math.PI/12,t.speed*t.mass/(t.mass-1),t.position),z(t.mass-1,e+Math.PI/12,t.speed*t.mass/(t.mass-1),t.position)}function V(t){t.computedVertices=t.vertexOffsets.map(((e,n,{length:o})=>{const i=t.r+2*Math.PI*(n/o);return new l(t.position.x+Math.sin(i)*e*t.radius,t.position.y+Math.cos(i)*e*t.radius)}))}function C(t){const e=function(t){for(const e of t){const t=H(a(e.x)),n=w.get(t);if(n&&e.y<=0&&e.y>=-n.height)return n}}(t.computedVertices);if(e)return e.health-=function(t){const e=t.health/t.maxHealth;return t.mass**2*e+(t.mass-1)**2*(1-e)}(t),void D(t);t.computedVertices.some((({y:t})=>t>0))&&D(t)}function Y(t){const e=2*Math.round(t)+3,n=[];for(let t=0;t<e;t+=1)n.push(s(.5,1));return n}function $(t,e,n){const o=[];for(const i of O){const s=i.position.distance(t);if(s>n)continue;const a=o.findIndex((([t])=>s<t));a>=0?(o.splice(a,0,[s,i]),o.length>e&&o.pop()):o.length<e&&o.push([s,i])}return o.map((([,t])=>t))}const q={build:(F=Object.values(d),G=(t,{left:e,active:n},{name:o,draw:i,width:s})=>{t.font="12px monospace",t.fillStyle=n?"#000":"#fff",t.textAlign="center",t.textBaseline="middle",t.fillText(o,e+32,749.5),i(t,new l(e+(64-s)/2,760.5))},J=({name:t})=>{T=t},K=()=>{const t=L();return t&&d[t]},{options:F,draw:(t,e)=>{for(const[n,o]of F.entries()){const i=8+72*n+.5,s=K?.()===o,a=n===e;t.fillStyle=s?"#fff":a?"#fff4":"#000",t.fillRect(i,736.5,64,56),t.strokeStyle="#fff",t.strokeRect(i,736.5,64,56),G(t,{left:i,active:s,hover:a},o)}},optionClick:J})};var F,G,J,K;const[Q,U]=function(t,e,n=!1){const o=document.createElement("canvas");o.width=t,o.height=e;const i=o.getContext("2d");return i.imageSmoothingEnabled=n,[o,i]}(500,800);Q.style.background="#000";let Z,_,tt,et=new l(12,-160),nt=1,ot=l.empty,it=l.empty,st=l.empty,at=l.empty,rt=!1;function lt({clientX:t,clientY:e}={clientX:NaN,clientY:NaN}){const n=Q.getBoundingClientRect();ot=new l(500/n.width*(t-n.left),800/n.height*(e-n.top)),it=ot.sub(new l(250,400)).mul(1/nt).add(et),Z=function(t){if(!(t.y<704)){for(let e=0;e<500/72;e+=1)if(t.within(8+72*e+.5,736.5,64,56))return e;return-1}}(ot)}function ct(t){et=t.sub(ot.sub(new l(250,400)).mul(1/nt));const[e,n]=j();et=et.ensureWithin(e+251/nt,401/nt-1200,n-e-502/nt,2400-802/nt),et=new l(Math.round(et.x*nt)/nt,Math.round(et.y*nt)/nt)}function ft(){st=l.empty,at=l.empty,_=void 0,tt=void 0,rt=!1}function ht(){U.resetTransform()}document.title="space-td";let dt=0;document.body.style.background="#49f",document.body.append(Q),document.addEventListener("mousemove",(t=>{lt(t),!rt&&st.distance(ot)>5&&(rt=!0),rt&&ct(at)})),Q.addEventListener("contextmenu",(t=>{t.preventDefault()})),Q.addEventListener("wheel",(t=>{lt(t),void 0===Z&&function({deltaY:t}){nt=Math.max(.5,Math.min(1.5,nt-.08333333333333333*Math.sign(t))),ct(it)}(t)})),Q.addEventListener("mousedown",(t=>{t.preventDefault(),lt(t),void 0!==Z?tt=Z:(st=ot,at=it,_=A(it))})),document.addEventListener("mouseup",(t=>{lt(t),void 0!==Z&&Z===tt?(E(void 0),function(t){void 0!==t&&t<q.build.options.length&&q.build.optionClick(q.build.options[t])}(Z)):rt||_!==A(it)||E(_),ft()})),document.addEventListener("visibilitychange",(()=>{ot=l.empty,it=l.empty,Z=void 0,ft()})),x("#0f0",(()=>O),(({radius:t,position:{x:e,y:n},health:o,maxHealth:i})=>({midX:e,y:n-t,width:2*t,value:o/i}))),i("objects",((t,{position:e,x1:n,x2:o})=>{const i=a(n),s=a(o);for(let n=i;n<=s;n+=-1===n?3:1){const o=w.get(n);if(!o){T&&X(t,n,e);continue}const i=new l(24*n,-o.height);o.health<=0&&(t.globalAlpha=.5),o.draw(t,i),o.health<=0&&(t.globalAlpha=1);const s=e.within(i.x,i.y,o.width,o.height);(n===k||s)&&u(t,i,o)}})),i("backgroundObjects",(t=>{const e=Math.max(Math.floor(15*B),0===v.size?0:8).toString(16);t.strokeStyle=`#f00${e}`;for(const e of w.values())if("turret"===e.name){t.lineWidth=e.power/2,t.beginPath();for(const n of e.targets)t.moveTo(e.mid.x,e.mid.y),t.lineTo(n.position.x,n.position.y);t.stroke()}t.lineWidth=1})),x("#0f0",(()=>w.values()),(({midX:t,width:e,height:n,health:o,maxHealth:i})=>({midX:t,width:e-2,y:-n-4,value:o/i}))),x("#66f",(()=>b),(({midX:t,width:e,height:n,energy:o,storage:i})=>({midX:t,width:e-2,y:-n-1,value:o/i}))),i("ground",((t,{x1:e,x2:n})=>{const o=a(e),i=a(n);t.fillStyle="sienna";for(let e=o;e<=i;e+=-1===e?2:1)t.fillRect(24*e,0,24,24)})),i("particles",(t=>{for(const e of y){const n=Math.floor(e.life/60*16);t.fillStyle=`${e.color}${n.toString(16)}`,t.fillRect(e.position.x-1.5,e.position.y-1.5,3,3)}})),function e(o){requestAnimationFrame(e),o>=dt+15.666666666666668&&(dt=o,r+=1,function(){y.size>g&&(g=y.size);for(const t of y)t.life-=1,0===t.life&&y.delete(t),t.position=t.position.add(t.dPosition)}(),function(){Math.random()>.05||O.size>=80||z();for(const t of O)t.health<=0?D(t):(t.position=t.position.add(t.dPosition),t.r+=t.dr,V(t),C(t))}(),function(){for(const[t,e]of w.entries())e.health<=0&&R(t,e);let t=0;for(const{efficiency:e}of v)t+=10*e*1;let e=0;for(const{energy:t}of b)e+=1e3*t;let n=0;for(const t of S){const{mid:e,count:o,range:i,power:s}=t;t.targets=$(e,o,200*i),n+=t.targets.length*o*s*15}const o=Math.min(n,t+e);B=o/n;for(const t of S){const{targets:e,power:n}=t;for(const t of e)t.health-=.02*n*B}let i=(t-o)/1e3;if(i>0){const t=[...b].sort(((t,e)=>e.energy-t.energy));for(let e=0;e<t.length;e+=1){const n=t[e],o=Math.min(i/(t.length-e),n.storage-n.energy);n.energy+=o,i-=o}}else if(i<0){const t=[...b].sort(((t,e)=>t.energy-e.energy));for(let e=0;e<t.length;e+=1){const n=t[e],o=Math.max(i/(t.length-e),-n.energy);n.energy+=o,i-=o}}}(),ht(),U.clearRect(0,0,500,800),U.translate(250,400),U.scale(nt,nt),U.translate(-et.x,-et.y),function(e,o){const i=t.map((()=>[]));for(const[t,e]of n.values())i[t].push(e);for(const t of i)for(const n of t)n(e,o)}(U,{position:it,x1:et.x-251/nt,y1:et.y-401/nt,x2:et.x+251/nt,y2:et.y+305/nt,width:502/nt,height:706/nt}),ht(),function(t,e){t.fillStyle="#000",t.fillRect(0,704,500,96),t.strokeStyle="#fff",t.strokeRect(-1,704.5,502,23),t.fillStyle="#fff",t.font="12px monospace",t.textAlign="left",t.textBaseline="middle",t.fillText("build",8,717.5),q.build.draw(t,e)}(U,Z))}(0);})()</script>
